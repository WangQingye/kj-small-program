"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const reqCountLimit = 5;
let loadList = [];
let loadedResList = [];
let caller = null;
let onProgress;
let onResLoaded;
let reqCount = 0;
let totalCount = 0;
function loadRes(resList, onProgressFun, onResLoadedFun, funCaller) {
    totalCount = resList.length;
    loadList = resList;
    onProgress = onProgressFun;
    onResLoaded = onResLoadedFun;
    caller = funCaller;
    startLoad();
}
exports.loadRes = loadRes;
function startLoad() {
    while (reqCount < reqCountLimit && loadList.length > 0) {
        let url = loadList.pop();
        reqCount++;
        loadSingleRes(url)
            .then(path => {
            reqCount--;
            onLoadSuccess(url, path);
        })
            .catch(err => {
            reqCount--;
            console.warn('load res error path=' + url, err);
            loadList.push(url);
        });
    }
}
function loadSingleRes(url) {
    return new Promise((resolve, reject) => {
        wx.downloadFile({
            url,
            success({ tempFilePath }) {
                resolve(tempFilePath);
            },
            fail: reject
        });
    });
}
function onLoadSuccess(origin, local) {
    loadedResList.push({ origin, local });
    if (onProgress && caller) {
        onProgress.call(caller, loadedResList.length);
    }
    if (loadedResList.length < totalCount) {
        setTimeout(() => {
            startLoad();
        }, 10);
    }
    else {
        if (onResLoaded && caller) {
            onResLoaded.call(caller, loadedResList);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzLWxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcy1sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUE7QUFDdkIsSUFBSSxRQUFRLEdBQWtCLEVBQUUsQ0FBQTtBQUNoQyxJQUFJLGFBQWEsR0FBNkMsRUFBRSxDQUFBO0FBQ2hFLElBQUksTUFBTSxHQUFRLElBQUksQ0FBQTtBQUN0QixJQUFJLFVBQW9CLENBQUE7QUFDeEIsSUFBSSxXQUFxQixDQUFBO0FBQ3pCLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQTtBQUNoQixJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUE7QUFFbEIsU0FBUyxPQUFPLENBQUMsT0FBc0IsRUFBRSxhQUF1QixFQUFFLGNBQXdCLEVBQUUsU0FBYztJQUN4RyxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQTtJQUMzQixRQUFRLEdBQUcsT0FBTyxDQUFBO0lBQ2xCLFVBQVUsR0FBRyxhQUFhLENBQUE7SUFDMUIsV0FBVyxHQUFHLGNBQWMsQ0FBQTtJQUM1QixNQUFNLEdBQUcsU0FBUyxDQUFBO0lBQ2xCLFNBQVMsRUFBRSxDQUFBO0FBQ2IsQ0FBQztBQWtEQywwQkFBTztBQWhEVCxTQUFTLFNBQVM7SUFDaEIsT0FBTyxRQUFRLEdBQUcsYUFBYSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3RELElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEVBQVksQ0FBQTtRQUNsQyxRQUFRLEVBQUUsQ0FBQTtRQUNWLGFBQWEsQ0FBQyxHQUFHLENBQUM7YUFDZixJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDWCxRQUFRLEVBQUUsQ0FBQTtZQUNWLGFBQWEsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDMUIsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ1gsUUFBUSxFQUFFLENBQUE7WUFDVixPQUFPLENBQUMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtZQUMvQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3BCLENBQUMsQ0FBQyxDQUFBO0tBQ0w7QUFDSCxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsR0FBRztJQUN4QixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3JDLEVBQUUsQ0FBQyxZQUFZLENBQUM7WUFDZCxHQUFHO1lBQ0gsT0FBTyxDQUFDLEVBQUUsWUFBWSxFQUFFO2dCQUN0QixPQUFPLENBQUMsWUFBWSxDQUFDLENBQUE7WUFDdkIsQ0FBQztZQUNELElBQUksRUFBRSxNQUFNO1NBQ2IsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsTUFBTSxFQUFFLEtBQUs7SUFDbEMsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO0lBQ3JDLElBQUksVUFBVSxJQUFJLE1BQU0sRUFBRTtRQUN4QixVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUE7S0FDOUM7SUFDRCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsVUFBVSxFQUFFO1FBQ3JDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxTQUFTLEVBQUUsQ0FBQTtRQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtLQUNQO1NBRUk7UUFDSCxJQUFJLFdBQVcsSUFBSSxNQUFNLEVBQUU7WUFDekIsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsYUFBYSxDQUFDLENBQUE7U0FDeEM7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCByZXFDb3VudExpbWl0ID0gNVxubGV0IGxvYWRMaXN0OiBBcnJheTxzdHJpbmc+ID0gW11cbmxldCBsb2FkZWRSZXNMaXN0OiBBcnJheTx7IG9yaWdpbjogc3RyaW5nOyBsb2NhbDogc3RyaW5nIH0+ID0gW11cbmxldCBjYWxsZXI6IGFueSA9IG51bGxcbmxldCBvblByb2dyZXNzOiBGdW5jdGlvblxubGV0IG9uUmVzTG9hZGVkOiBGdW5jdGlvblxubGV0IHJlcUNvdW50ID0gMFxubGV0IHRvdGFsQ291bnQgPSAwXG5cbmZ1bmN0aW9uIGxvYWRSZXMocmVzTGlzdDogQXJyYXk8c3RyaW5nPiwgb25Qcm9ncmVzc0Z1bjogRnVuY3Rpb24sIG9uUmVzTG9hZGVkRnVuOiBGdW5jdGlvbiwgZnVuQ2FsbGVyOiBhbnkpIHtcbiAgdG90YWxDb3VudCA9IHJlc0xpc3QubGVuZ3RoXG4gIGxvYWRMaXN0ID0gcmVzTGlzdFxuICBvblByb2dyZXNzID0gb25Qcm9ncmVzc0Z1blxuICBvblJlc0xvYWRlZCA9IG9uUmVzTG9hZGVkRnVuXG4gIGNhbGxlciA9IGZ1bkNhbGxlclxuICBzdGFydExvYWQoKVxufVxuXG5mdW5jdGlvbiBzdGFydExvYWQoKSB7XG4gIHdoaWxlIChyZXFDb3VudCA8IHJlcUNvdW50TGltaXQgJiYgbG9hZExpc3QubGVuZ3RoID4gMCkge1xuICAgIGxldCB1cmwgPSBsb2FkTGlzdC5wb3AoKSBhcyBzdHJpbmdcbiAgICByZXFDb3VudCsrXG4gICAgbG9hZFNpbmdsZVJlcyh1cmwpXG4gICAgICAudGhlbihwYXRoID0+IHtcbiAgICAgICAgcmVxQ291bnQtLVxuICAgICAgICBvbkxvYWRTdWNjZXNzKHVybCwgcGF0aClcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmVxQ291bnQtLVxuICAgICAgICBjb25zb2xlLndhcm4oJ2xvYWQgcmVzIGVycm9yIHBhdGg9JyArIHVybCwgZXJyKVxuICAgICAgICBsb2FkTGlzdC5wdXNoKHVybClcbiAgICAgIH0pXG4gIH1cbn1cblxuZnVuY3Rpb24gbG9hZFNpbmdsZVJlcyh1cmwpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB3eC5kb3dubG9hZEZpbGUoe1xuICAgICAgdXJsLFxuICAgICAgc3VjY2Vzcyh7IHRlbXBGaWxlUGF0aCB9KSB7XG4gICAgICAgIHJlc29sdmUodGVtcEZpbGVQYXRoKVxuICAgICAgfSxcbiAgICAgIGZhaWw6IHJlamVjdFxuICAgIH0pXG4gIH0pXG59XG5cbmZ1bmN0aW9uIG9uTG9hZFN1Y2Nlc3Mob3JpZ2luLCBsb2NhbCkge1xuICBsb2FkZWRSZXNMaXN0LnB1c2goeyBvcmlnaW4sIGxvY2FsIH0pXG4gIGlmIChvblByb2dyZXNzICYmIGNhbGxlcikge1xuICAgIG9uUHJvZ3Jlc3MuY2FsbChjYWxsZXIsIGxvYWRlZFJlc0xpc3QubGVuZ3RoKVxuICB9XG4gIGlmIChsb2FkZWRSZXNMaXN0Lmxlbmd0aCA8IHRvdGFsQ291bnQpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHN0YXJ0TG9hZCgpXG4gICAgfSwgMTApXG4gIH1cbiAgLy8g5Yqg6L295a6M5q+VXG4gIGVsc2Uge1xuICAgIGlmIChvblJlc0xvYWRlZCAmJiBjYWxsZXIpIHtcbiAgICAgIG9uUmVzTG9hZGVkLmNhbGwoY2FsbGVyLCBsb2FkZWRSZXNMaXN0KVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQge1xuICBsb2FkUmVzXG59Il19