"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const pixel_handler_1 = require("../../utils/pixel-handler");
Component({
    properties: {
        config: {
            type: Object,
            value: null
        }
    },
    data: {
        inited: false,
        containerSize: [200, 200],
        containerStyle: '',
        pos: [0, 0],
        offset: [0, 0],
        showPanel: false,
        baseSize: [200, 300],
    },
    methods: {
        setFrame() { },
        setEnter() {
            if (!this.data.inited) {
                this.setData({ inited: true });
                this.initRender();
            }
        },
        setExit() { },
        initRender() {
            wx.showLoading({ title: '', mask: true });
            const { base_pic, sign_pic } = this.data.config;
            if (base_pic && sign_pic) {
                Promise.all([
                    this.getStageSize(),
                    this.getImgSize(base_pic),
                    this.getImgSize(sign_pic),
                ]).then(arr => {
                    this.setData({
                        stageSize: arr[0],
                        baseSize: arr[1],
                        signSize: arr[2],
                        baseUrl: arr[1][2],
                        signUrl: arr[2][2],
                    });
                    this.setCanvasContainer();
                }).catch(err => {
                    console.warn('getImgInfo error:', err);
                });
            }
        },
        getImgSize(url) {
            return new Promise((resolve, reject) => {
                wx.getImageInfo({
                    src: url,
                    success({ width, height, path }) {
                        resolve([width, height, path]);
                    },
                    fail: reject,
                });
            });
        },
        getStageSize() {
            return new Promise((resolve, reject) => {
                wx.getSystemInfo({
                    success({ windowWidth, windowHeight }) {
                        resolve([windowWidth, windowHeight]);
                    },
                    fail: reject
                });
            });
        },
        setCanvasContainer() {
            this.setContainerSize();
            this.setContext();
        },
        setContainerSize() {
            const { stageSize, baseSize, signSize, } = this.data;
            const [cw, ch] = [
                stageSize[0],
                ~~(baseSize[1] * stageSize[0] / baseSize[0])
            ];
            this.setData({
                containerSize: [cw, ch],
                containerStyle: [
                    `width:${cw}px;`,
                    `height:${ch}px;`,
                ].join('')
            });
            const scale = stageSize[0] / baseSize[0];
            const [sdw, sdh] = [
                ~~(scale * signSize[0]),
                ~~(scale * signSize[1]),
            ];
            this.setData({
                signDisplaySize: [sdw, sdh],
                signStyle: [
                    `width:${sdw}px;`,
                    `height:${sdh}px;`,
                ].join('')
            });
        },
        setContext() {
            const { baseSize, containerSize, signSize, signDisplaySize, } = this.data;
            const [bw, bh] = baseSize;
            const [sw, sh] = signSize;
            const [sdw, sdh] = signDisplaySize;
            const that = this;
            const baseCtx = wx.createCanvasContext(`base-${this.data.config.id}`, this);
            this.setData({ baseCtx });
            baseCtx.drawImage(this.data.baseUrl, 0, 0, bw, bh, 0, 0, bw, bh);
            baseCtx.draw(false);
            const signCtx = wx.createCanvasContext(`sign-${this.data.config.id}`, this);
            this.setData({ signCtx });
            signCtx.drawImage(this.data.signUrl, 0, 0, sw, sh, 0, 0, sdw, sdh);
            signCtx.draw(false, function () {
                that.saveOriginData();
                that.onFirstDraw();
            });
        },
        saveOriginData() {
            const { signDisplaySize, } = this.data;
            const [sdw, sdh] = signDisplaySize;
            const that = this;
            wx.canvasGetImageData({
                canvasId: `sign-${this.data.config.id}`,
                x: 0,
                y: 0,
                width: sdw,
                height: sdh,
                success(res) {
                    console.log('imgdata size : ' + res.width + 'X' + res.height);
                    that.signData = res.data;
                    that.signDataSize = [res.width, res.height];
                }
            }, this);
        },
        onFirstDraw() {
            const { signDisplaySize, } = this.data;
            const [sdw, sdh] = signDisplaySize;
            const that = this;
            wx.canvasToTempFilePath({
                x: 0,
                y: 0,
                width: sdw,
                height: sdh,
                quality: 1,
                canvasId: `sign-${this.data.config.id}`,
                success({ tempFilePath }) {
                    that.setData({
                        tempSignUrl: tempFilePath
                    });
                    wx.getImageInfo({
                        src: tempFilePath,
                        success(res) {
                            that.setData({
                                tempSize: [res.width, res.height]
                            });
                            wx.hideLoading();
                        },
                        fail() {
                            wx.hideLoading();
                        }
                    });
                },
                fail(err) {
                    wx.hideLoading();
                    console.warn('tempFilePath error:', err);
                }
            }, this);
        },
        onTouchStart(e) {
            const { pageX, pageY } = e.touches[0];
            this.setData({
                offset: [~~pageX, ~~pageY],
                touchTs: Date.now(),
                touchPos: [~~pageX, ~~pageY],
            });
        },
        onTouchMove(e) {
            let [posX, posY] = this.data.pos;
            const [offsetX, offsetY] = this.data.offset;
            const x = ~~(e.touches[0].pageX);
            const y = ~~(e.touches[0].pageY);
            posX = ~~(posX + x - offsetX);
            posY = ~~(posY + y - offsetY);
            this.setData({
                pos: [posX, posY],
                offset: [x, y]
            });
        },
        onTouchEnd(e) {
            const { pageX, pageY } = e.changedTouches[0];
            const { touchTs, touchPos } = this.data;
            const dis = Math.sqrt(Math.pow((pageX - touchPos[0]), 2) +
                Math.pow((pageY - touchPos[1]), 2));
            if (Date.now() - touchTs < 300 && dis < 30) {
                this.onSwitchPanel();
            }
        },
        onPickColor({ detail }) {
            let rgb = [0, 0, 0];
            try {
                rgb = detail.replace('rgb(', '').replace(')', '').split(',').map(c => +c);
            }
            catch (e) {
                console.warn('convert color error:', e);
            }
            this.renderSignImg(rgb);
        },
        renderSignImg(rgb) {
            wx.showLoading({ title: '保存中', mask: true });
            const that = this;
            const pixels = pixel_handler_1.colorMatrixFilter(this.signData, rgb);
            wx.canvasPutImageData({
                canvasId: `sign-${this.data.config.id}`,
                x: 0,
                y: 0,
                width: this.signDataSize[0],
                height: this.signDataSize[1],
                data: pixels,
                success() {
                    that.onFirstDraw();
                }
            }, this);
        },
        onSaveImg() {
            wx.showLoading({ title: '保存中', mask: true });
            const { baseSize, signSize, containerSize, tempSize, pos, } = this.data;
            const [bw, bh] = baseSize;
            const [sw, sh] = signSize;
            const [cw] = containerSize;
            const [tw, th] = tempSize;
            const scale = cw / bw;
            if (this.data.baseCtx) {
                this.data.baseCtx.drawImage(this.data.baseUrl, 0, 0, bw, bh, 0, 0, bw, bh);
                this.data.baseCtx.drawImage(this.data.tempSignUrl, 0, 0, tw, th, ~~(pos[0] / scale), ~~(pos[1] / scale), sw, sh);
                this.data.baseCtx.draw(false, () => {
                    this.convertCanvas2TempFile();
                });
            }
        },
        convertCanvas2TempFile() {
            const { baseSize } = this.data;
            const [bw, bh] = baseSize;
            const that = this;
            wx.canvasToTempFilePath({
                x: 0,
                y: 0,
                width: bw,
                height: bh,
                quality: 1,
                canvasId: `base-${this.data.config.id}`,
                success({ tempFilePath }) {
                    that.saveImageFile2Album(tempFilePath);
                },
                fail(err) {
                    console.warn('tempFilePath error:', err);
                    wx.hideLoading();
                }
            }, this);
        },
        saveImageFile2Album(filePath) {
            wx.saveImageToPhotosAlbum({
                filePath,
                success() {
                    wx.showToast({
                        title: '保存成功',
                        icon: 'success',
                        duration: 1000
                    });
                },
                complete() {
                    wx.hideLoading();
                }
            });
        },
        onSwitchPanel() {
            this.setData({
                showPanel: !this.data.showPanel
            });
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5b3V0NS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxheW91dDUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2REFBNkQ7QUFFN0QsU0FBUyxDQUFDO0lBR1IsVUFBVSxFQUFFO1FBQ1YsTUFBTSxFQUFFO1lBQ04sSUFBSSxFQUFFLE1BQU07WUFDWixLQUFLLEVBQUUsSUFBSTtTQUNaO0tBQ0Y7SUFHRCxJQUFJLEVBQUU7UUFFSixNQUFNLEVBQUUsS0FBSztRQUViLGFBQWEsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFFekIsY0FBYyxFQUFFLEVBQUU7UUFFbEIsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVYLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFZCxTQUFTLEVBQUUsS0FBSztRQUVoQixRQUFRLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO0tBQ3JCO0lBR0QsT0FBTyxFQUFFO1FBRVAsUUFBUSxLQUFLLENBQUM7UUFFZCxRQUFRO1lBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7Z0JBQzlCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTthQUNsQjtRQUNILENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQztRQUNiLFVBQVU7WUFDUixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUN6QyxNQUFNLEVBQ0osUUFBUSxFQUNSLFFBQVEsRUFDVCxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBO1lBQ3BCLElBQUksUUFBUSxJQUFJLFFBQVEsRUFBRTtnQkFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQztvQkFDVixJQUFJ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QixFQUFFLENBQUMsb0JBQW9CLENBQUM7Z0JBQ3RCLENBQUMsRUFBRSxDQUFDO2dCQUNKLENBQUMsRUFBRSxDQUFDO2dCQUNKLEtBQUssRUFBRSxFQUFFO2dCQUNULE1BQU0sRUFBRSxFQUFFO2dCQUNWLE9BQU8sRUFBRSxDQUFDO2dCQUNWLFFBQVEsRUFBRSxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDdkMsT0FBTyxDQUFDLEVBQUUsWUFBWSxFQUFFO29CQUN0QixJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUE7Z0JBQ3hDLENBQUM7Z0JBQ0QsSUFBSSxDQUFDLEdBQUc7b0JBQ04sT0FBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLENBQUMsQ0FBQTtvQkFDeEMsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO2dCQUNsQixDQUFDO2FBQ0YsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNWLENBQUM7UUFFRCxtQkFBbUIsQ0FBQyxRQUFRO1lBQzFCLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQztnQkFDeEIsUUFBUTtnQkFDUixPQUFPO29CQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUM7d0JBQ1gsS0FBSyxFQUFFLE1BQU07d0JBQ2IsSUFBSSxFQUFFLFNBQVM7d0JBQ2YsUUFBUSxFQUFFLElBQUk7cUJBQ2YsQ0FBQyxDQUFBO2dCQUNKLENBQUM7Z0JBQ0QsUUFBUTtvQkFDTixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7Z0JBQ2xCLENBQUM7YUFDRixDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsYUFBYTtZQUNYLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTO2FBQ2hDLENBQUMsQ0FBQTtRQUNKLENBQUM7S0FDRjtDQUVGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbG9yTWF0cml4RmlsdGVyIH0gZnJvbSAnLi4vLi4vdXRpbHMvcGl4ZWwtaGFuZGxlcidcblxuQ29tcG9uZW50KHtcblxuICAvKiog57uE5Lu255qE5bGe5oCn5YiX6KGoICovXG4gIHByb3BlcnRpZXM6IHtcbiAgICBjb25maWc6IHtcbiAgICAgIHR5cGU6IE9iamVjdCxcbiAgICAgIHZhbHVlOiBudWxsXG4gICAgfVxuICB9LFxuXG4gIC8qKiDnu4Tku7bnmoTliJ3lp4vmlbDmja4gKi9cbiAgZGF0YToge1xuICAgIC8qKiDmmK/lkKblt7Lnu4/liJ3lp4vljJYgKi9cbiAgICBpbml0ZWQ6IGZhbHNlLFxuICAgIC8qKiDnlLvluIPlrrnlmajlpKflsI8gKi9cbiAgICBjb250YWluZXJTaXplOiBbMjAwLCAyMDBdLFxuICAgIC8qKiDnlLvluIPlrrnlmajmoLflvI8gKi9cbiAgICBjb250YWluZXJTdHlsZTogJycsXG4gICAgLyoqIOetvuWQjeWbvuWdkOaghyAqL1xuICAgIHBvczogWzAsIDBdLFxuICAgIC8qKiDop6bmjqfngrnlgY/np7vph48gKi9cbiAgICBvZmZzZXQ6IFswLCAwXSxcbiAgICAvKiog5piv5ZCm5pi+56S66LCD6Imy5p2/ICovXG4gICAgc2hvd1BhbmVsOiBmYWxzZSxcbiAgICAvKiog5bqV5Zu+5bC65a+4ICovXG4gICAgYmFzZVNpemU6IFsyMDAsIDMwMF0sXG4gIH0sXG5cbiAgLyoqIOe7hOS7tueahOaWueazleWIl+ihqCAqL1xuICBtZXRob2RzOiB7XG4gICAgLyoqIOi/m+WFpeWSjOmAgOWHuueahOe8k+WKqOWKqOeUuyAqL1xuICAgIHNldEZyYW1lKCkgeyB9LFxuICAgIC8qKiDpobXpnaLov5vlhaUgKi9cbiAgICBzZXRFbnRlcigpIHtcbiAgICAgIGlmICghdGhpcy5kYXRhLmluaXRlZCkge1xuICAgICAgICB0aGlzLnNldERhdGEoeyBpbml0ZWQ6IHRydWUgfSlcbiAgICAgICAgdGhpcy5pbml0UmVuZGVyKClcbiAgICAgIH1cbiAgICB9LFxuICAgIC8qKiDpobXpnaLpgIDlh7ogKi9cbiAgICBzZXRFeGl0KCkgeyB9LFxuICAgIGluaXRSZW5kZXIoKSB7XG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAnJywgbWFzazogdHJ1ZSB9KVxuICAgICAgY29uc3Qge1xuICAgICAgICBiYXNlX3BpYyxcbiAgICAgICAgc2lnbl9waWNcbiAgICAgIH0gPSB0aGlzLmRhdGEuY29uZmlnXG4gICAgICBpZiAoYmFzZV9waWMgJiYgc2lnbl9waWMpIHtcbiAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIHRoaXMuZ2V0U3RhZ2VTaXplKCksXG4gICAgICAgICAgdGhpcy5nZXRJbWdTaXplKGJhc2VfcGljKSxcbiAgICAgICAgICB0aGlzLmdldEltZ1NpemUoc2lnbl9waWMpLFxuICAgICAgICBdKS50aGVuKGFyciA9PiB7XG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIC8qKiDoiJ7lj7DlsLrlr7ggKi9cbiAgICAgICAgICAgIHN0YWdlU2l6ZTogYXJyWzBdLFxuICAgICAgICAgICAgLyoqIOW6leWbvuWwuuWvuCAqL1xuICAgICAgICAgICAgYmFzZVNpemU6IGFyclsxXSxcbiAgICAgICAgICAgIC8qKiDnrb7lkI3lm77lsLrlr7ggKi9cbiAgICAgICAgICAgIHNpZ25TaXplOiBhcnJbMl0sXG4gICAgICAgICAgICAvKiog5bqV5Zu+5pys5Zyw5Zyw5Z2AICovXG4gICAgICAgICAgICBiYXNlVXJsOiBhcnJbMV1bMl0sXG4gICAgICAgICAgICAvKiog562+5ZCN5Zu+5pys5Zyw5Zyw5Z2AICovXG4gICAgICAgICAgICBzaWduVXJsOiBhcnJbMl1bMl0sXG4gICAgICAgICAgfSlcbiAgICAgICAgICB0aGlzLnNldENhbnZhc0NvbnRhaW5lcigpXG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgY29uc29sZS53YXJuKCdnZXRJbWdJbmZvIGVycm9yOicsIGVycilcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9LFxuICAgIC8qKiDojrflj5blm77niYfkv6Hmga8gKi9cbiAgICBnZXRJbWdTaXplKHVybCkge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgd3guZ2V0SW1hZ2VJbmZvKHtcbiAgICAgICAgICBzcmM6IHVybCxcbiAgICAgICAgICBzdWNjZXNzKHsgd2lkdGgsIGhlaWdodCwgcGF0aCB9KSB7XG4gICAgICAgICAgICByZXNvbHZlKFt3aWR0aCwgaGVpZ2h0LCBwYXRoXSlcbiAgICAgICAgICB9LFxuICAgICAgICAgIGZhaWw6IHJlamVjdCxcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSxcbiAgICAvKiog6I635Y+W6Iie5Y+w5bC65a+4ICovXG4gICAgZ2V0U3RhZ2VTaXplKCkge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgd3guZ2V0U3lzdGVtSW5mbyh7XG4gICAgICAgICAgc3VjY2Vzcyh7IHdpbmRvd1dpZHRoLCB3aW5kb3dIZWlnaHQgfSkge1xuICAgICAgICAgICAgcmVzb2x2ZShbd2luZG93V2lkdGgsIHdpbmRvd0hlaWdodF0pXG4gICAgICAgICAgfSxcbiAgICAgICAgICBmYWlsOiByZWplY3RcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSxcbiAgICAvKiog5Yid5aeL5YyW55S75biD5a655ZmoICovXG4gICAgc2V0Q2FudmFzQ29udGFpbmVyKCkge1xuICAgICAgdGhpcy5zZXRDb250YWluZXJTaXplKClcbiAgICAgIHRoaXMuc2V0Q29udGV4dCgpXG4gICAgfSxcbiAgICAvKiog6K6+572u55S75biD5a655Zmo5aSn5bCPICovXG4gICAgc2V0Q29udGFpbmVyU2l6ZSgpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgc3RhZ2VTaXplLFxuICAgICAgICBiYXNlU2l6ZSxcbiAgICAgICAgc2lnblNpemUsXG4gICAgICB9ID0gdGhpcy5kYXRhXG4gICAgICAvLyBjb250YWluZXJcbiAgICAgIGNvbnN0IFtjdywgY2hdID0gW1xuICAgICAgICBzdGFnZVNpemVbMF0sXG4gICAgICAgIH5+KGJhc2VTaXplWzFdICogc3RhZ2VTaXplWzBdIC8gYmFzZVNpemVbMF0pXG4gICAgICBdXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBjb250YWluZXJTaXplOiBbY3csIGNoXSxcbiAgICAgICAgY29udGFpbmVyU3R5bGU6IFtcbiAgICAgICAgICBgd2lkdGg6JHtjd31weDtgLFxuICAgICAgICAgIGBoZWlnaHQ6JHtjaH1weDtgLFxuICAgICAgICBdLmpvaW4oJycpXG4gICAgICB9KVxuICAgICAgLy8gc2lnblxuICAgICAgY29uc3Qgc2NhbGUgPSBzdGFnZVNpemVbMF0gLyBiYXNlU2l6ZVswXVxuICAgICAgY29uc3QgW3Nkdywgc2RoXSA9IFtcbiAgICAgICAgfn4oc2NhbGUgKiBzaWduU2l6ZVswXSksXG4gICAgICAgIH5+KHNjYWxlICogc2lnblNpemVbMV0pLFxuICAgICAgXVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgc2lnbkRpc3BsYXlTaXplOiBbc2R3LCBzZGhdLFxuICAgICAgICBzaWduU3R5bGU6IFtcbiAgICAgICAgICBgd2lkdGg6JHtzZHd9cHg7YCxcbiAgICAgICAgICBgaGVpZ2h0OiR7c2RofXB4O2AsXG4gICAgICAgIF0uam9pbignJylcbiAgICAgIH0pXG4gICAgfSxcbiAgICAvKiog5Yid5aeL5YyW562+5ZCN5Zu+57uY5Zu+5LiK5LiL5paH546v5aKDICovXG4gICAgc2V0Q29udGV4dCgpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgYmFzZVNpemUsXG4gICAgICAgIGNvbnRhaW5lclNpemUsXG4gICAgICAgIHNpZ25TaXplLFxuICAgICAgICBzaWduRGlzcGxheVNpemUsXG4gICAgICB9ID0gdGhpcy5kYXRhXG4gICAgICBjb25zdCBbYncsIGJoXSA9IGJhc2VTaXplXG4gICAgICAvLyBjb25zdCBbY3csIGNoXSA9IGNvbnRhaW5lclNpemVcbiAgICAgIGNvbnN0IFtzdywgc2hdID0gc2lnblNpemVcbiAgICAgIGNvbnN0IFtzZHcsIHNkaF0gPSBzaWduRGlzcGxheVNpemVcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICAvLyBiYXNlQ3R4XG4gICAgICBjb25zdCBiYXNlQ3R4ID0gd3guY3JlYXRlQ2FudmFzQ29udGV4dChgYmFzZS0ke3RoaXMuZGF0YS5jb25maWcuaWR9YCwgdGhpcylcbiAgICAgIHRoaXMuc2V0RGF0YSh7IGJhc2VDdHggfSlcbiAgICAgIGJhc2VDdHguZHJhd0ltYWdlKHRoaXMuZGF0YS5iYXNlVXJsLCAwLCAwLCBidywgYmgsIDAsIDAsIGJ3LCBiaClcbiAgICAgIGJhc2VDdHguZHJhdyhmYWxzZSlcbiAgICAgIC8vIHNpZ25DdHhcbiAgICAgIGNvbnN0IHNpZ25DdHggPSB3eC5jcmVhdGVDYW52YXNDb250ZXh0KGBzaWduLSR7dGhpcy5kYXRhLmNvbmZpZy5pZH1gLCB0aGlzKVxuICAgICAgdGhpcy5zZXREYXRhKHsgc2lnbkN0eCB9KVxuICAgICAgc2lnbkN0eC5kcmF3SW1hZ2UodGhpcy5kYXRhLnNpZ25VcmwsIDAsIDAsIHN3LCBzaCwgMCwgMCwgc2R3LCBzZGgpXG4gICAgICBzaWduQ3R4LmRyYXcoZmFsc2UsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhhdC5zYXZlT3JpZ2luRGF0YSgpXG4gICAgICAgIHRoYXQub25GaXJzdERyYXcoKVxuICAgICAgfSlcbiAgICB9LFxuICAgIC8qKiDkv53lrZjljp/lp4vlg4/ntKAgKi9cbiAgICBzYXZlT3JpZ2luRGF0YSgpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgc2lnbkRpc3BsYXlTaXplLFxuICAgICAgfSA9IHRoaXMuZGF0YVxuICAgICAgY29uc3QgW3Nkdywgc2RoXSA9IHNpZ25EaXNwbGF5U2l6ZVxuICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgIHd4LmNhbnZhc0dldEltYWdlRGF0YSh7XG4gICAgICAgIGNhbnZhc0lkOiBgc2lnbi0ke3RoaXMuZGF0YS5jb25maWcuaWR9YCxcbiAgICAgICAgeDogMCxcbiAgICAgICAgeTogMCxcbiAgICAgICAgd2lkdGg6IHNkdyxcbiAgICAgICAgaGVpZ2h0OiBzZGgsXG4gICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ2ltZ2RhdGEgc2l6ZSA6ICcgKyByZXMud2lkdGggKyAnWCcgKyByZXMuaGVpZ2h0KSAvLyAxMDBcbiAgICAgICAgICB0aGF0LnNpZ25EYXRhID0gcmVzLmRhdGFcbiAgICAgICAgICB0aGF0LnNpZ25EYXRhU2l6ZSA9IFtyZXMud2lkdGgsIHJlcy5oZWlnaHRdXG4gICAgICAgIH1cbiAgICAgIH0sIHRoaXMpXG4gICAgfSxcbiAgICAvKiog6aaW5qyh57uY5Yi25oiQ5Yqf5a+85Ye65pi+56S655So5Zu+54mHICovXG4gICAgb25GaXJzdERyYXcoKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHNpZ25EaXNwbGF5U2l6ZSxcbiAgICAgIH0gPSB0aGlzLmRhdGFcbiAgICAgIGNvbnN0IFtzZHcsIHNkaF0gPSBzaWduRGlzcGxheVNpemVcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICB3eC5jYW52YXNUb1RlbXBGaWxlUGF0aCh7XG4gICAgICAgIHg6IDAsXG4gICAgICAgIHk6IDAsXG4gICAgICAgIHdpZHRoOiBzZHcsXG4gICAgICAgIGhlaWdodDogc2RoLFxuICAgICAgICBxdWFsaXR5OiAxLFxuICAgICAgICBjYW52YXNJZDogYHNpZ24tJHt0aGlzLmRhdGEuY29uZmlnLmlkfWAsXG4gICAgICAgIHN1Y2Nlc3MoeyB0ZW1wRmlsZVBhdGggfSkge1xuICAgICAgICAgIHRoYXQuc2V0RGF0YSh7XG4gICAgICAgICAgICB0ZW1wU2lnblVybDogdGVtcEZpbGVQYXRoXG4gICAgICAgICAgfSlcbiAgICAgICAgICB3eC5nZXRJbWFnZUluZm8oe1xuICAgICAgICAgICAgc3JjOiB0ZW1wRmlsZVBhdGgsXG4gICAgICAgICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgICB0aGF0LnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHRlbXBTaXplOiBbcmVzLndpZHRoLCByZXMuaGVpZ2h0XVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmFpbCgpIHtcbiAgICAgICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0sXG4gICAgICAgIGZhaWwoZXJyKSB7XG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICAgIGNvbnNvbGUud2FybigndGVtcEZpbGVQYXRoIGVycm9yOicsIGVycilcbiAgICAgICAgfVxuICAgICAgfSwgdGhpcylcbiAgICB9LFxuICAgIC8qKiBvblRvdWNoU3RhcnQgKi9cbiAgICBvblRvdWNoU3RhcnQoZSkge1xuICAgICAgY29uc3QgeyBwYWdlWCwgcGFnZVkgfSA9IGUudG91Y2hlc1swXVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgb2Zmc2V0OiBbfn5wYWdlWCwgfn5wYWdlWV0sXG4gICAgICAgIHRvdWNoVHM6IERhdGUubm93KCksXG4gICAgICAgIHRvdWNoUG9zOiBbfn5wYWdlWCwgfn5wYWdlWV0sXG4gICAgICB9KVxuICAgIH0sXG4gICAgLyoqIG9uVG91Y2hNb3ZlICovXG4gICAgb25Ub3VjaE1vdmUoZSkge1xuICAgICAgbGV0IFtwb3NYLCBwb3NZXSA9IHRoaXMuZGF0YS5wb3NcbiAgICAgIGNvbnN0IFtvZmZzZXRYLCBvZmZzZXRZXSA9IHRoaXMuZGF0YS5vZmZzZXRcbiAgICAgIGNvbnN0IHggPSB+fihlLnRvdWNoZXNbMF0ucGFnZVgpXG4gICAgICBjb25zdCB5ID0gfn4oZS50b3VjaGVzWzBdLnBhZ2VZKVxuICAgICAgcG9zWCA9IH5+KHBvc1ggKyB4IC0gb2Zmc2V0WClcbiAgICAgIHBvc1kgPSB+fihwb3NZICsgeSAtIG9mZnNldFkpXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBwb3M6IFtwb3NYLCBwb3NZXSxcbiAgICAgICAgb2Zmc2V0OiBbeCwgeV1cbiAgICAgIH0pXG4gICAgfSxcbiAgICAvKiogb25Ub3VjaEVuZCAqL1xuICAgIG9uVG91Y2hFbmQoZSkge1xuICAgICAgY29uc3QgeyBwYWdlWCwgcGFnZVkgfSA9IGUuY2hhbmdlZFRvdWNoZXNbMF1cbiAgICAgIGNvbnN0IHsgdG91Y2hUcywgdG91Y2hQb3MgfSA9IHRoaXMuZGF0YVxuICAgICAgY29uc3QgZGlzID0gTWF0aC5zcXJ0KFxuICAgICAgICBNYXRoLnBvdygocGFnZVggLSB0b3VjaFBvc1swXSksIDIpICtcbiAgICAgICAgTWF0aC5wb3coKHBhZ2VZIC0gdG91Y2hQb3NbMV0pLCAyKVxuICAgICAgKVxuICAgICAgaWYgKERhdGUubm93KCkgLSB0b3VjaFRzIDwgMzAwICYmIGRpcyA8IDMwKSB7XG4gICAgICAgIHRoaXMub25Td2l0Y2hQYW5lbCgpXG4gICAgICB9XG4gICAgfSxcbiAgICAvKiog6YCJ5oup6aKc6ImyICovXG4gICAgb25QaWNrQ29sb3IoeyBkZXRhaWwgfSkge1xuICAgICAgbGV0IHJnYiA9IFswLCAwLCAwXVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmdiID0gZGV0YWlsLnJlcGxhY2UoJ3JnYignLCAnJykucmVwbGFjZSgnKScsICcnKS5zcGxpdCgnLCcpLm1hcChjID0+ICtjKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLndhcm4oJ2NvbnZlcnQgY29sb3IgZXJyb3I6JywgZSlcbiAgICAgIH1cbiAgICAgIHRoaXMucmVuZGVyU2lnbkltZyhyZ2IpXG4gICAgfSxcbiAgICAvKiog5riy5p+T562+5ZCN5Zu+ICovXG4gICAgcmVuZGVyU2lnbkltZyhyZ2IpIHtcbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfkv53lrZjkuK0nLCBtYXNrOiB0cnVlIH0pXG4gICAgICBjb25zdCB0aGF0ID0gdGhpc1xuICAgICAgY29uc3QgcGl4ZWxzID0gY29sb3JNYXRyaXhGaWx0ZXIodGhpcy5zaWduRGF0YSwgcmdiKVxuICAgICAgd3guY2FudmFzUHV0SW1hZ2VEYXRhKHtcbiAgICAgICAgY2FudmFzSWQ6IGBzaWduLSR7dGhpcy5kYXRhLmNvbmZpZy5pZH1gLFxuICAgICAgICB4OiAwLFxuICAgICAgICB5OiAwLFxuICAgICAgICB3aWR0aDogdGhpcy5zaWduRGF0YVNpemVbMF0sXG4gICAgICAgIGhlaWdodDogdGhpcy5zaWduRGF0YVNpemVbMV0sXG4gICAgICAgIGRhdGE6IHBpeGVscyxcbiAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICB0aGF0Lm9uRmlyc3REcmF3KClcbiAgICAgICAgfVxuICAgICAgfSwgdGhpcylcbiAgICB9LFxuICAgIC8qKiDngrnlh7vkv53lrZjmjInpkq4gKi9cbiAgICBvblNhdmVJbWcoKSB7XG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5L+d5a2Y5LitJywgbWFzazogdHJ1ZSB9KVxuICAgICAgY29uc3Qge1xuICAgICAgICBiYXNlU2l6ZSxcbiAgICAgICAgc2lnblNpemUsXG4gICAgICAgIGNvbnRhaW5lclNpemUsXG4gICAgICAgIHRlbXBTaXplLFxuICAgICAgICBwb3MsXG4gICAgICB9ID0gdGhpcy5kYXRhXG4gICAgICBjb25zdCBbYncsIGJoXSA9IGJhc2VTaXplXG4gICAgICBjb25zdCBbc3csIHNoXSA9IHNpZ25TaXplXG4gICAgICBjb25zdCBbY3ddID0gY29udGFpbmVyU2l6ZVxuICAgICAgY29uc3QgW3R3LCB0aF0gPSB0ZW1wU2l6ZVxuICAgICAgY29uc3Qgc2NhbGUgPSBjdyAvIGJ3XG4gICAgICBpZiAodGhpcy5kYXRhLmJhc2VDdHgpIHtcbiAgICAgICAgdGhpcy5kYXRhLmJhc2VDdHguZHJhd0ltYWdlKHRoaXMuZGF0YS5iYXNlVXJsLCAwLCAwLCBidywgYmgsIDAsIDAsIGJ3LCBiaClcbiAgICAgICAgLyoqIFxuICAgICAgICAgKiDnkIborrrkuIrlj4LmlbAgNO+8jDUg5bqU6K+l5pivIHNkd+WSjHN3aO+8jOaooeaLn+WZqOS5n+aYr3Nkd+WSjHNkaO+8jOecn+acuuW/hemhu+agueaNruS4tOaXtuWbvueJh+WunumZheWwuuWvuOi/m+ihjOiuvue9rlxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kYXRhLmJhc2VDdHguZHJhd0ltYWdlKHRoaXMuZGF0YS50ZW1wU2lnblVybCwgMCwgMCwgdHcsIHRoLCB+fihwb3NbMF0gLyBzY2FsZSksIH5+KHBvc1sxXSAvIHNjYWxlKSwgc3csIHNoKVxuICAgICAgICB0aGlzLmRhdGEuYmFzZUN0eC5kcmF3KGZhbHNlLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jb252ZXJ0Q2FudmFzMlRlbXBGaWxlKClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9LFxuICAgIC8qKiDlsIblkIjmiJDlm77ovazmjaLkuLrkuLTml7blm77niYfmlofku7YgKi9cbiAgICBjb252ZXJ0Q2FudmFzMlRlbXBGaWxlKCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBiYXNlU2l6ZVxuICAgICAgfSA9IHRoaXMuZGF0YVxuICAgICAgY29uc3QgW2J3LCBiaF0gPSBiYXNlU2l6ZVxuICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgIHd4LmNhbnZhc1RvVGVtcEZpbGVQYXRoKHtcbiAgICAgICAgeDogMCxcbiAgICAgICAgeTogMCxcbiAgICAgICAgd2lkdGg6IGJ3LFxuICAgICAgICBoZWlnaHQ6IGJoLFxuICAgICAgICBxdWFsaXR5OiAxLFxuICAgICAgICBjYW52YXNJZDogYGJhc2UtJHt0aGlzLmRhdGEuY29uZmlnLmlkfWAsXG4gICAgICAgIHN1Y2Nlc3MoeyB0ZW1wRmlsZVBhdGggfSkge1xuICAgICAgICAgIHRoYXQuc2F2ZUltYWdlRmlsZTJBbGJ1bSh0ZW1wRmlsZVBhdGgpXG4gICAgICAgIH0sXG4gICAgICAgIGZhaWwoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKCd0ZW1wRmlsZVBhdGggZXJyb3I6JywgZXJyKVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgfVxuICAgICAgfSwgdGhpcylcbiAgICB9LFxuICAgIC8qKiDkv53lrZjlm77niYfliLDnm7jlhowgKi9cbiAgICBzYXZlSW1hZ2VGaWxlMkFsYnVtKGZpbGVQYXRoKSB7XG4gICAgICB3eC5zYXZlSW1hZ2VUb1Bob3Rvc0FsYnVtKHtcbiAgICAgICAgZmlsZVBhdGgsXG4gICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAn5L+d5a2Y5oiQ5YqfJyxcbiAgICAgICAgICAgIGljb246ICdzdWNjZXNzJyxcbiAgICAgICAgICAgIGR1cmF0aW9uOiAxMDAwXG4gICAgICAgICAgfSlcbiAgICAgICAgfSxcbiAgICAgICAgY29tcGxldGUoKSB7XG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0sXG4gICAgLyoqIOWIh+aNouiwg+iJsuadv+aYvuekuueKtuaAgSAqL1xuICAgIG9uU3dpdGNoUGFuZWwoKSB7XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBzaG93UGFuZWw6ICF0aGlzLmRhdGEuc2hvd1BhbmVsXG4gICAgICB9KVxuICAgIH0sXG4gIH0sXG5cbn0pXG4iXX0=