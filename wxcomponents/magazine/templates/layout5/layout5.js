"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const pixel_handler_1 = require("../../utils/pixel-handler");
Component({
    properties: {
        config: {
            type: Object,
            value: null
        }
    },
    data: {
        inited: false,
        containerSize: [200, 200],
        containerStyle: '',
        pos: [0, 0],
        offset: [0, 0],
        showPanel: false,
        baseSize: [200, 300],
    },
    methods: {
        setFrame() { },
        setEnter() {
            if (!this.data.inited) {
                this.setData({ inited: true });
                this.initRender();
            }
        },
        setExit() { },
        initRender() {
            wx.showLoading({ title: '', mask: true });
            const { base_pic, sign_pic } = this.data.config;
            if (base_pic && sign_pic) {
                Promise.all([
                    this.getStageSize(),
                    this.getImgSize(base_pic),
                    this.getImgSize(sign_pic),
                ]).then(arr => {
                    this.setData({
                        stageSize: arr[0],
                        baseSize: arr[1],
                        signSize: arr[2],
                        baseUrl: arr[1][2],
                        signUrl: arr[2][2],
                    });
                    this.setCanvasContainer();
                }).catch(err => {
                    console.warn('getImgInfo error:', err);
                });
            }
        },
        getImgSize(url) {
            return new Promise((resolve, reject) => {
                wx.getImageInfo({
                    src: url,
                    success({ width, height, path }) {
                        resolve([width, height, path]);
                    },
                    fail: reject,
                });
            });
        },
        getStageSize() {
            return new Promise((resolve, reject) => {
                wx.getSystemInfo({
                    success({ windowWidth, windowHeight }) {
                        resolve([windowWidth, windowHeight]);
                    },
                    fail: reject
                });
            });
        },
        setCanvasContainer() {
            this.setContainerSize();
            this.setContext();
        },
        setContainerSize() {
            const { stageSize, baseSize, signSize, } = this.data;
            const [cw, ch] = [
                stageSize[0],
                ~~(baseSize[1] * stageSize[0] / baseSize[0])
            ];
            this.setData({
                containerSize: [cw, ch],
                containerStyle: [
                    `width:${cw}px;`,
                    `height:${ch}px;`,
                ].join('')
            });
            const scale = stageSize[0] / baseSize[0];
            const [sdw, sdh] = [
                ~~(scale * signSize[0]),
                ~~(scale * signSize[1]),
            ];
            this.setData({
                signDisplaySize: [sdw, sdh],
                signStyle: [
                    `width:${sdw}px;`,
                    `height:${sdh}px;`,
                ].join('')
            });
        },
        setContext() {
            const { baseSize, containerSize, signSize, signDisplaySize, } = this.data;
            const [bw, bh] = baseSize;
            const [sw, sh] = signSize;
            const [sdw, sdh] = signDisplaySize;
            const that = this;
            const baseCtx = wx.createCanvasContext(`base-${this.data.config.id}`, this);
            this.setData({ baseCtx });
            baseCtx.drawImage(this.data.baseUrl, 0, 0, bw, bh, 0, 0, bw, bh);
            baseCtx.draw(false);
            const signCtx = wx.createCanvasContext(`sign-${this.data.config.id}`, this);
            this.setData({ signCtx });
            signCtx.drawImage(this.data.signUrl, 0, 0, sw, sh, 0, 0, sdw, sdh);
            signCtx.draw(false, function () {
                that.saveOriginData();
                that.onFirstDraw();
            });
        },
        saveOriginData() {
            const { signDisplaySize, } = this.data;
            const [sdw, sdh] = signDisplaySize;
            const that = this;
            wx.canvasGetImageData({
                canvasId: `sign-${this.data.config.id}`,
                x: 0,
                y: 0,
                width: sdw,
                height: sdh,
                success(res) {
                    console.log('imgdata size : ' + res.width + 'X' + res.height);
                    that.signData = res.data;
                    that.signDataSize = [res.width, res.height];
                }
            }, this);
        },
        onFirstDraw() {
            const { signDisplaySize, } = this.data;
            const [sdw, sdh] = signDisplaySize;
            const that = this;
            wx.canvasToTempFilePath({
                x: 0,
                y: 0,
                width: sdw,
                height: sdh,
                quality: 1,
                canvasId: `sign-${this.data.config.id}`,
                success({ tempFilePath }) {
                    that.setData({
                        tempSignUrl: tempFilePath
                    });
                    wx.getImageInfo({
                        src: tempFilePath,
                        success(res) {
                            that.setData({
                                tempSize: [res.width, res.height]
                            });
                            wx.hideLoading();
                        },
                        fail() {
                            wx.hideLoading();
                        }
                    });
                },
                fail(err) {
                    wx.hideLoading();
                    console.warn('tempFilePath error:', err);
                }
            }, this);
        },
        onTouchStart(e) {
            const [posX, posY] = this.data.pos;
            const { pageX, pageY } = e.touches[0];
            const { offsetLeft, offsetTop } = e.currentTarget;
            const x = ~~(pageX - offsetLeft);
            const y = ~~(pageY - offsetTop);
            const [sdw, sdh] = this.data.signDisplaySize;
            let isMovingSign = false;
            if (posX <= x &&
                x <= posX + sdw &&
                posY <= y &&
                y <= posY + sdh) {
                isMovingSign = true;
            }
            const [offsetX, offsetY] = [x - posX, y - posY];
            this.setData({
                isMovingSign,
                offset: [offsetX, offsetY],
                touchTs: Date.now(),
                touchPos: [pageX, pageY],
            });
        },
        onTouchMove(e) {
            if (!this.data.isMovingSign) {
                return;
            }
            const [offsetX, offsetY] = this.data.offset;
            const x = ~~(e.touches[0].pageX - e.currentTarget.offsetLeft);
            const y = ~~(e.touches[0].pageY - e.currentTarget.offsetTop);
            const [sdw, sdh] = this.data.signDisplaySize;
            const [cw, ch] = this.data.containerSize;
            let [posX, posY] = [x - offsetX, y - offsetY];
            posX = Math.max(0, posX);
            posX = Math.min(cw - sdw, posX);
            posY = Math.max(0, posY);
            posY = Math.min(ch - sdh, posY);
            this.setData({
                pos: [posX, posY]
            });
        },
        onTouchEnd(e) {
            const { pageX, pageY } = e.changedTouches[0];
            const { touchTs, touchPos } = this.data;
            const dis = Math.sqrt(Math.pow((pageX - touchPos[0]), 2) +
                Math.pow((pageY - touchPos[1]), 2));
            if (Date.now() - touchTs < 300 && dis < 30) {
                this.onSwitchPanel();
            }
        },
        onPickColor({ detail }) {
            let rgb = [0, 0, 0];
            try {
                rgb = detail.replace('rgb(', '').replace(')', '').split(',').map(c => +c);
            }
            catch (e) {
                console.warn('convert color error:', e);
            }
            this.renderSignImg(rgb);
        },
        renderSignImg(rgb) {
            wx.showLoading({ title: '保存中', mask: true });
            const that = this;
            const pixels = pixel_handler_1.colorMatrixFilter(this.signData, rgb);
            wx.canvasPutImageData({
                canvasId: `sign-${this.data.config.id}`,
                x: 0,
                y: 0,
                width: this.signDataSize[0],
                height: this.signDataSize[1],
                data: pixels,
                success() {
                    that.onFirstDraw();
                }
            }, this);
        },
        onSaveImg() {
            wx.showLoading({ title: '保存中', mask: true });
            const { baseSize, signSize, containerSize, tempSize, pos, } = this.data;
            const [bw, bh] = baseSize;
            const [sw, sh] = signSize;
            const [cw] = containerSize;
            const [tw, th] = tempSize;
            const scale = cw / bw;
            if (this.data.baseCtx) {
                this.data.baseCtx.drawImage(this.data.baseUrl, 0, 0, bw, bh, 0, 0, bw, bh);
                this.data.baseCtx.drawImage(this.data.tempSignUrl, 0, 0, tw, th, ~~(pos[0] / scale), ~~(pos[1] / scale), sw, sh);
                this.data.baseCtx.draw(false, () => {
                    this.convertCanvas2TempFile();
                });
            }
        },
        convertCanvas2TempFile() {
            const { baseSize } = this.data;
            const [bw, bh] = baseSize;
            const that = this;
            wx.canvasToTempFilePath({
                x: 0,
                y: 0,
                width: bw,
                height: bh,
                quality: 1,
                canvasId: `base-${this.data.config.id}`,
                success({ tempFilePath }) {
                    that.saveImageFile2Album(tempFilePath);
                },
                fail(err) {
                    console.warn('tempFilePath error:', err);
                    wx.hideLoading();
                }
            }, this);
        },
        saveImageFile2Album(filePath) {
            wx.saveImageToPhotosAlbum({
                filePath,
                success() {
                    wx.showToast({
                        title: '保存成功',
                        icon: 'success',
                        duration: 1000
                    });
                },
                complete() {
                    wx.hideLoading();
                }
            });
        },
        onSwitchPanel() {
            this.setData({
                showPanel: !this.data.showPanel
            });
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF5b3V0NS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxheW91dDUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2REFBNkQ7QUFFN0QsU0FBUyxDQUFDO0lBR1IsVUFBVSxFQUFFO1FBQ1YsTUFBTSxFQUFFO1lBQ04sSUFBSSxFQUFFLE1BQU07WUFDWixLQUFLLEVBQUUsSUFBSTtTQUNaO0tBQ0Y7SUFHRCxJQUFJLEVBQUU7UUFFSixNQUFNLEVBQUUsS0FBSztRQUViLGFBQWEsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFFekIsY0FBYyxFQUFFLEVBQUU7UUFFbEIsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVYLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFZCxTQUFTLEVBQUUsS0FBSztRQUVoQixRQUFRLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO0tBQ3JCO0lBR0QsT0FBTyxFQUFFO1FBRVAsUUFBUSxLQUFLLENBQUM7UUFFZCxRQUFRO1lBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7Z0JBQzlCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTthQUNsQjtRQUNILENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQztRQUNiLFVBQVU7WUFDUixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUN6QyxNQUFNLEVBQ0osUUFBUSxFQUNSLFFBQVEsRUFDVCxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBO1lBQ3BCLElBQUksUUFBUSxJQUFJLFFBQVEsRUFBRTtnQkFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQztvQkFDVixJQUFJLENBQUMsWUFBWSxFQUFFO29CQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQztvQkFDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUM7aUJBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFFWCxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQzt3QkFFakIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7d0JBRWhCLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO3dCQUVoQixPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFFbEIsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7cUJBQ25CLENBQUMsQ0FBQTtvQkFDRixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQTtnQkFDM0IsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUNiLE9BQU8sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxDQUFDLENBQUE7Z0JBQ3hDLENBQUMsQ0FBQyxDQUFBO2FBQ0g7UUFDSCxDQUFDO1FBRUQsVUFBVSxDQUFDLEdBQUc7WUFDWixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUNyQyxFQUFFLENBQUMsWUFBWSxDQUFDO29CQUNkLEdBQUcsRUFBRSxHQUFHO29CQUNSLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3dCQUM3QixPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUE7b0JBQ2hDLENBQUM7b0JBQ0QsSUFBSSxFQUFFLE1BQU07aUJBQ2IsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsWUFBWTtZQUNWLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQ3JDLEVBQUUsQ0FBQyxhQUFhLENBQUM7b0JBQ2YsT0FBTyxDQUFDLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRTt3QkFDbkMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUE7b0JBQ3RDLENBQUM7b0JBQ0QsSUFBSSxFQUFFLE1BQU07aUJBQ2IsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsa0JBQWtCO1lBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1lBQ3ZCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUNuQixDQUFDO1FBRUQsZ0JBQWdCO1lBQ2QsTUFBTSxFQUNKLFNBQVMsRUFDVCxRQUFRLEVBQ1IsUUFBUSxHQUNULEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtZQUViLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUc7Z0JBQ2YsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDWixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUM3QyxDQUFBO1lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxhQUFhLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDO2dCQUN2QixjQUFjLEVBQUU7b0JBQ2QsU0FBUyxFQUFFLEtBQUs7b0JBQ2hCLFVBQVUsRUFBRSxLQUFLO2lCQUNsQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7YUFDWCxDQUFDLENBQUE7WUFFRixNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3hDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUc7Z0JBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDeEIsQ0FBQTtZQUNELElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsZUFBZSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztnQkFDM0IsU0FBUyxFQUFFO29CQUNULFNBQVMsR0FBRyxLQUFLO29CQUNqQixVQUFVLEdBQUcsS0FBSztpQkFDbkIsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2FBQ1gsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUVELFVBQVU7WUFDUixNQUFNLEVBQ0osUUFBUSxFQUNSLGFBQWEsRUFDYixRQUFRLEVBQ1IsZUFBZSxHQUNoQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUE7WUFDYixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQTtZQUV6QixNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQTtZQUN6QixNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLGVBQWUsQ0FBQTtZQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUE7WUFFakIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUE7WUFDM0UsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7WUFDekIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDaEUsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUVuQixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUMsbUJBQW1CLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUMzRSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQTtZQUN6QixPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtZQUNsRSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDbEIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFBO2dCQUNyQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDcEIsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsY0FBYztZQUNaLE1BQU0sRUFDSixlQUFlLEdBQ2hCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtZQUNiLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsZUFBZSxDQUFBO1lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQTtZQUNqQixFQUFFLENBQUMsa0JBQWtCLENBQUM7Z0JBQ3BCLFFBQVEsRUFBRSxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDdkMsQ0FBQyxFQUFFLENBQUM7Z0JBQ0osQ0FBQyxFQUFFLENBQUM7Z0JBQ0osS0FBSyxFQUFFLEdBQUc7Z0JBQ1YsTUFBTSxFQUFFLEdBQUc7Z0JBQ1gsT0FBTyxDQUFDLEdBQUc7b0JBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsS0FBSyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7b0JBQzdELElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQTtvQkFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUM3QyxDQUFDO2FBQ0YsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNWLENBQUM7UUFFRCxXQUFXO1lBQ1QsTUFBTSxFQUNKLGVBQWUsR0FDaEIsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO1lBQ2IsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxlQUFlLENBQUE7WUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFBO1lBQ2pCLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDdEIsQ0FBQyxFQUFFLENBQUM7Z0JBQ0osQ0FBQyxFQUFFLENBQUM7Z0JBQ0osS0FBSyxFQUFFLEdBQUc7Z0JBQ1YsTUFBTSxFQUFFLEdBQUc7Z0JBQ1gsT0FBTyxFQUFFLENBQUM7Z0JBQ1YsUUFBUSxFQUFFLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFO2dCQUN2QyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUU7b0JBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUM7d0JBQ1gsV0FBVyxFQUFFLFlBQVk7cUJBQzFCLENBQUMsQ0FBQTtvQkFDRixFQUFFLENBQUMsWUFBWSxDQUFDO3dCQUNkLEdBQUcsRUFBRSxZQUFZO3dCQUNqQixPQUFPLENBQUMsR0FBRzs0QkFDVCxJQUFJLENBQUMsT0FBTyxDQUFDO2dDQUNYLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQzs2QkFDbEMsQ0FBQyxDQUFBOzRCQUNGLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTt3QkFDbEIsQ0FBQzt3QkFDRCxJQUFJOzRCQUNGLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTt3QkFDbEIsQ0FBQztxQkFDRixDQUFDLENBQUE7Z0JBQ0osQ0FBQztnQkFDRCxJQUFJLENBQUMsR0FBRztvQkFDTixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7b0JBQ2hCLE9BQU8sQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsR0FBRyxDQUFDLENBQUE7Z0JBQzFDLENBQUM7YUFDRixFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ1YsQ0FBQztRQUVELFlBQVksQ0FBQyxDQUFDO1lBQ1osTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQTtZQUNsQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDckMsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUMsYUFBYSxDQUFBO1lBQ2pELE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsQ0FBQTtZQUNoQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUE7WUFDL0IsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQTtZQUM1QyxJQUFJLFlBQVksR0FBRyxLQUFLLENBQUE7WUFDeEIsSUFDRSxJQUFJLElBQUksQ0FBQztnQkFDVCxDQUFDLElBQUksSUFBSSxHQUFHLEdBQUc7Z0JBQ2YsSUFBSSxJQUFJLENBQUM7Z0JBQ1QsQ0FBQyxJQUFJLElBQUksR0FBRyxHQUFHLEVBQ2Y7Z0JBQ0EsWUFBWSxHQUFHLElBQUksQ0FBQTthQUNwQjtZQUNELE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQTtZQUMvQyxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLFlBQVk7Z0JBQ1osTUFBTSxFQUFFLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQztnQkFDMUIsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ25CLFFBQVEsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUM7YUFDekIsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUVELFdBQVcsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUMzQixPQUFNO2FBQ1A7WUFDRCxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBO1lBQzNDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDN0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUM1RCxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFBO1lBQzVDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUE7WUFDeEMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxPQUFPLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFBO1lBQzdDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUN4QixJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQy9CLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUN4QixJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQy9CLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQzthQUNsQixDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsVUFBVSxDQUFDLENBQUM7WUFDVixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDNUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO1lBQ3ZDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQ25CLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNsQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUNuQyxDQUFBO1lBQ0QsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsT0FBTyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsRUFBRSxFQUFFO2dCQUMxQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7YUFDckI7UUFDSCxDQUFDO1FBRUQsV0FBVyxDQUFDLEVBQUUsTUFBTSxFQUFFO1lBQ3BCLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUNuQixJQUFJO2dCQUNGLEdBQUcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQzFFO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsT0FBTyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsQ0FBQTthQUN4QztZQUNELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDekIsQ0FBQztRQUVELGFBQWEsQ0FBQyxHQUFHO1lBQ2YsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7WUFDNUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFBO1lBQ2pCLE1BQU0sTUFBTSxHQUFHLGlDQUFpQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUE7WUFDcEQsRUFBRSxDQUFDLGtCQUFrQixDQUFDO2dCQUNwQixRQUFRLEVBQUUsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7Z0JBQ3ZDLENBQUMsRUFBRSxDQUFDO2dCQUNKLENBQUMsRUFBRSxDQUFDO2dCQUNKLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFDM0IsTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixJQUFJLEVBQUUsTUFBTTtnQkFDWixPQUFPO29CQUNMLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtnQkFDcEIsQ0FBQzthQUNGLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDVixDQUFDO1FBRUQsU0FBUztZQUNQLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1lBQzVDLE1BQU0sRUFDSixRQUFRLEVBQ1IsUUFBUSxFQUNSLGFBQWEsRUFDYixRQUFRLEVBQ1IsR0FBRyxHQUNKLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtZQUNiLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFBO1lBQ3pCLE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFBO1lBQ3pCLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUE7WUFDMUIsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUE7WUFDekIsTUFBTSxLQUFLLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQTtZQUNyQixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO2dCQUkxRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO2dCQUNoSCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtvQkFDakMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUE7Z0JBQy9CLENBQUMsQ0FBQyxDQUFBO2FBQ0g7UUFDSCxDQUFDO1FBRUQsc0JBQXNCO1lBQ3BCLE1BQU0sRUFDSixRQUFRLEVBQ1QsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO1lBQ2IsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUE7WUFDekIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFBO1lBQ2pCLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDdEIsQ0FBQyxFQUFFLENBQUM7Z0JBQ0osQ0FBQyxFQUFFLENBQUM7Z0JBQ0osS0FBSyxFQUFFLEVBQUU7Z0JBQ1QsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLENBQUM7Z0JBQ1YsUUFBUSxFQUFFLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFO2dCQUN2QyxPQUFPLENBQUMsRUFBRSxZQUFZLEVBQUU7b0JBQ3RCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLENBQUMsQ0FBQTtnQkFDeEMsQ0FBQztnQkFDRCxJQUFJLENBQUMsR0FBRztvQkFDTixPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsQ0FBQyxDQUFBO29CQUN4QyxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7Z0JBQ2xCLENBQUM7YUFDRixFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ1YsQ0FBQztRQUVELG1CQUFtQixDQUFDLFFBQVE7WUFDMUIsRUFBRSxDQUFDLHNCQUFzQixDQUFDO2dCQUN4QixRQUFRO2dCQUNSLE9BQU87b0JBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQzt3QkFDWCxLQUFLLEVBQUUsTUFBTTt3QkFDYixJQUFJLEVBQUUsU0FBUzt3QkFDZixRQUFRLEVBQUUsSUFBSTtxQkFDZixDQUFDLENBQUE7Z0JBQ0osQ0FBQztnQkFDRCxRQUFRO29CQUNOLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtnQkFDbEIsQ0FBQzthQUNGLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFFRCxhQUFhO1lBQ1gsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7YUFDaEMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztLQUNGO0NBRUYsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29sb3JNYXRyaXhGaWx0ZXIgfSBmcm9tICcuLi8uLi91dGlscy9waXhlbC1oYW5kbGVyJ1xuXG5Db21wb25lbnQoe1xuXG4gIC8qKiDnu4Tku7bnmoTlsZ7mgKfliJfooaggKi9cbiAgcHJvcGVydGllczoge1xuICAgIGNvbmZpZzoge1xuICAgICAgdHlwZTogT2JqZWN0LFxuICAgICAgdmFsdWU6IG51bGxcbiAgICB9XG4gIH0sXG5cbiAgLyoqIOe7hOS7tueahOWIneWni+aVsOaNriAqL1xuICBkYXRhOiB7XG4gICAgLyoqIOaYr+WQpuW3sue7j+WIneWni+WMliAqL1xuICAgIGluaXRlZDogZmFsc2UsXG4gICAgLyoqIOeUu+W4g+WuueWZqOWkp+WwjyAqL1xuICAgIGNvbnRhaW5lclNpemU6IFsyMDAsIDIwMF0sXG4gICAgLyoqIOeUu+W4g+WuueWZqOagt+W8jyAqL1xuICAgIGNvbnRhaW5lclN0eWxlOiAnJyxcbiAgICAvKiog562+5ZCN5Zu+5Z2Q5qCHICovXG4gICAgcG9zOiBbMCwgMF0sXG4gICAgLyoqIOinpuaOp+eCueWBj+enu+mHjyAqL1xuICAgIG9mZnNldDogWzAsIDBdLFxuICAgIC8qKiDmmK/lkKbmmL7npLrosIPoibLmnb8gKi9cbiAgICBzaG93UGFuZWw6IGZhbHNlLFxuICAgIC8qKiDlupXlm77lsLrlr7ggKi9cbiAgICBiYXNlU2l6ZTogWzIwMCwgMzAwXSxcbiAgfSxcblxuICAvKiog57uE5Lu255qE5pa55rOV5YiX6KGoICovXG4gIG1ldGhvZHM6IHtcbiAgICAvKiog6L+b5YWl5ZKM6YCA5Ye655qE57yT5Yqo5Yqo55S7ICovXG4gICAgc2V0RnJhbWUoKSB7IH0sXG4gICAgLyoqIOmhtemdoui/m+WFpSAqL1xuICAgIHNldEVudGVyKCkge1xuICAgICAgaWYgKCF0aGlzLmRhdGEuaW5pdGVkKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7IGluaXRlZDogdHJ1ZSB9KVxuICAgICAgICB0aGlzLmluaXRSZW5kZXIoKVxuICAgICAgfVxuICAgIH0sXG4gICAgLyoqIOmhtemdoumAgOWHuiAqL1xuICAgIHNldEV4aXQoKSB7IH0sXG4gICAgaW5pdFJlbmRlcigpIHtcbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICcnLCBtYXNrOiB0cnVlIH0pXG4gICAgICBjb25zdCB7XG4gICAgICAgIGJhc2VfcGljLFxuICAgICAgICBzaWduX3BpY1xuICAgICAgfSA9IHRoaXMuZGF0YS5jb25maWdcbiAgICAgIGlmIChiYXNlX3BpYyAmJiBzaWduX3BpYykge1xuICAgICAgICBQcm9taXNlLmFsbChbXG4gICAgICAgICAgdGhpcy5nZXRTdGFnZVNpemUoKSxcbiAgICAgICAgICB0aGlzLmdldEltZ1NpemUoYmFzZV9waWMpLFxuICAgICAgICAgIHRoaXMuZ2V0SW1nU2l6ZShzaWduX3BpYyksXG4gICAgICAgIF0pLnRoZW4oYXJyID0+IHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgLyoqIOiInuWPsOWwuuWvuCAqL1xuICAgICAgICAgICAgc3RhZ2VTaXplOiBhcnJbMF0sXG4gICAgICAgICAgICAvKiog5bqV5Zu+5bC65a+4ICovXG4gICAgICAgICAgICBiYXNlU2l6ZTogYXJyWzFdLFxuICAgICAgICAgICAgLyoqIOetvuWQjeWbvuWwuuWvuCAqL1xuICAgICAgICAgICAgc2lnblNpemU6IGFyclsyXSxcbiAgICAgICAgICAgIC8qKiDlupXlm77mnKzlnLDlnLDlnYAgKi9cbiAgICAgICAgICAgIGJhc2VVcmw6IGFyclsxXVsyXSxcbiAgICAgICAgICAgIC8qKiDnrb7lkI3lm77mnKzlnLDlnLDlnYAgKi9cbiAgICAgICAgICAgIHNpZ25Vcmw6IGFyclsyXVsyXSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc2V0Q2FudmFzQ29udGFpbmVyKClcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ2dldEltZ0luZm8gZXJyb3I6JywgZXJyKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0sXG4gICAgLyoqIOiOt+WPluWbvueJh+S/oeaBryAqL1xuICAgIGdldEltZ1NpemUodXJsKSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICB3eC5nZXRJbWFnZUluZm8oe1xuICAgICAgICAgIHNyYzogdXJsLFxuICAgICAgICAgIHN1Y2Nlc3MoeyB3aWR0aCwgaGVpZ2h0LCBwYXRoIH0pIHtcbiAgICAgICAgICAgIHJlc29sdmUoW3dpZHRoLCBoZWlnaHQsIHBhdGhdKVxuICAgICAgICAgIH0sXG4gICAgICAgICAgZmFpbDogcmVqZWN0LFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9LFxuICAgIC8qKiDojrflj5boiJ7lj7DlsLrlr7ggKi9cbiAgICBnZXRTdGFnZVNpemUoKSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICB3eC5nZXRTeXN0ZW1JbmZvKHtcbiAgICAgICAgICBzdWNjZXNzKHsgd2luZG93V2lkdGgsIHdpbmRvd0hlaWdodCB9KSB7XG4gICAgICAgICAgICByZXNvbHZlKFt3aW5kb3dXaWR0aCwgd2luZG93SGVpZ2h0XSlcbiAgICAgICAgICB9LFxuICAgICAgICAgIGZhaWw6IHJlamVjdFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9LFxuICAgIC8qKiDliJ3lp4vljJbnlLvluIPlrrnlmaggKi9cbiAgICBzZXRDYW52YXNDb250YWluZXIoKSB7XG4gICAgICB0aGlzLnNldENvbnRhaW5lclNpemUoKVxuICAgICAgdGhpcy5zZXRDb250ZXh0KClcbiAgICB9LFxuICAgIC8qKiDorr7nva7nlLvluIPlrrnlmajlpKflsI8gKi9cbiAgICBzZXRDb250YWluZXJTaXplKCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBzdGFnZVNpemUsXG4gICAgICAgIGJhc2VTaXplLFxuICAgICAgICBzaWduU2l6ZSxcbiAgICAgIH0gPSB0aGlzLmRhdGFcbiAgICAgIC8vIGNvbnRhaW5lclxuICAgICAgY29uc3QgW2N3LCBjaF0gPSBbXG4gICAgICAgIHN0YWdlU2l6ZVswXSxcbiAgICAgICAgfn4oYmFzZVNpemVbMV0gKiBzdGFnZVNpemVbMF0gLyBiYXNlU2l6ZVswXSlcbiAgICAgIF1cbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGNvbnRhaW5lclNpemU6IFtjdywgY2hdLFxuICAgICAgICBjb250YWluZXJTdHlsZTogW1xuICAgICAgICAgIGB3aWR0aDoke2N3fXB4O2AsXG4gICAgICAgICAgYGhlaWdodDoke2NofXB4O2AsXG4gICAgICAgIF0uam9pbignJylcbiAgICAgIH0pXG4gICAgICAvLyBzaWduXG4gICAgICBjb25zdCBzY2FsZSA9IHN0YWdlU2l6ZVswXSAvIGJhc2VTaXplWzBdXG4gICAgICBjb25zdCBbc2R3LCBzZGhdID0gW1xuICAgICAgICB+fihzY2FsZSAqIHNpZ25TaXplWzBdKSxcbiAgICAgICAgfn4oc2NhbGUgKiBzaWduU2l6ZVsxXSksXG4gICAgICBdXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBzaWduRGlzcGxheVNpemU6IFtzZHcsIHNkaF0sXG4gICAgICAgIHNpZ25TdHlsZTogW1xuICAgICAgICAgIGB3aWR0aDoke3Nkd31weDtgLFxuICAgICAgICAgIGBoZWlnaHQ6JHtzZGh9cHg7YCxcbiAgICAgICAgXS5qb2luKCcnKVxuICAgICAgfSlcbiAgICB9LFxuICAgIC8qKiDliJ3lp4vljJbnrb7lkI3lm77nu5jlm77kuIrkuIvmlofnjq/looMgKi9cbiAgICBzZXRDb250ZXh0KCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBiYXNlU2l6ZSxcbiAgICAgICAgY29udGFpbmVyU2l6ZSxcbiAgICAgICAgc2lnblNpemUsXG4gICAgICAgIHNpZ25EaXNwbGF5U2l6ZSxcbiAgICAgIH0gPSB0aGlzLmRhdGFcbiAgICAgIGNvbnN0IFtidywgYmhdID0gYmFzZVNpemVcbiAgICAgIC8vIGNvbnN0IFtjdywgY2hdID0gY29udGFpbmVyU2l6ZVxuICAgICAgY29uc3QgW3N3LCBzaF0gPSBzaWduU2l6ZVxuICAgICAgY29uc3QgW3Nkdywgc2RoXSA9IHNpZ25EaXNwbGF5U2l6ZVxuICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgIC8vIGJhc2VDdHhcbiAgICAgIGNvbnN0IGJhc2VDdHggPSB3eC5jcmVhdGVDYW52YXNDb250ZXh0KGBiYXNlLSR7dGhpcy5kYXRhLmNvbmZpZy5pZH1gLCB0aGlzKVxuICAgICAgdGhpcy5zZXREYXRhKHsgYmFzZUN0eCB9KVxuICAgICAgYmFzZUN0eC5kcmF3SW1hZ2UodGhpcy5kYXRhLmJhc2VVcmwsIDAsIDAsIGJ3LCBiaCwgMCwgMCwgYncsIGJoKVxuICAgICAgYmFzZUN0eC5kcmF3KGZhbHNlKVxuICAgICAgLy8gc2lnbkN0eFxuICAgICAgY29uc3Qgc2lnbkN0eCA9IHd4LmNyZWF0ZUNhbnZhc0NvbnRleHQoYHNpZ24tJHt0aGlzLmRhdGEuY29uZmlnLmlkfWAsIHRoaXMpXG4gICAgICB0aGlzLnNldERhdGEoeyBzaWduQ3R4IH0pXG4gICAgICBzaWduQ3R4LmRyYXdJbWFnZSh0aGlzLmRhdGEuc2lnblVybCwgMCwgMCwgc3csIHNoLCAwLCAwLCBzZHcsIHNkaClcbiAgICAgIHNpZ25DdHguZHJhdyhmYWxzZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGF0LnNhdmVPcmlnaW5EYXRhKClcbiAgICAgICAgdGhhdC5vbkZpcnN0RHJhdygpXG4gICAgICB9KVxuICAgIH0sXG4gICAgLyoqIOS/neWtmOWOn+Wni+WDj+e0oCAqL1xuICAgIHNhdmVPcmlnaW5EYXRhKCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBzaWduRGlzcGxheVNpemUsXG4gICAgICB9ID0gdGhpcy5kYXRhXG4gICAgICBjb25zdCBbc2R3LCBzZGhdID0gc2lnbkRpc3BsYXlTaXplXG4gICAgICBjb25zdCB0aGF0ID0gdGhpc1xuICAgICAgd3guY2FudmFzR2V0SW1hZ2VEYXRhKHtcbiAgICAgICAgY2FudmFzSWQ6IGBzaWduLSR7dGhpcy5kYXRhLmNvbmZpZy5pZH1gLFxuICAgICAgICB4OiAwLFxuICAgICAgICB5OiAwLFxuICAgICAgICB3aWR0aDogc2R3LFxuICAgICAgICBoZWlnaHQ6IHNkaCxcbiAgICAgICAgc3VjY2VzcyhyZXMpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnaW1nZGF0YSBzaXplIDogJyArIHJlcy53aWR0aCArICdYJyArIHJlcy5oZWlnaHQpIC8vIDEwMFxuICAgICAgICAgIHRoYXQuc2lnbkRhdGEgPSByZXMuZGF0YVxuICAgICAgICAgIHRoYXQuc2lnbkRhdGFTaXplID0gW3Jlcy53aWR0aCwgcmVzLmhlaWdodF1cbiAgICAgICAgfVxuICAgICAgfSwgdGhpcylcbiAgICB9LFxuICAgIC8qKiDpppbmrKHnu5jliLbmiJDlip/lr7zlh7rmmL7npLrnlKjlm77niYcgKi9cbiAgICBvbkZpcnN0RHJhdygpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgc2lnbkRpc3BsYXlTaXplLFxuICAgICAgfSA9IHRoaXMuZGF0YVxuICAgICAgY29uc3QgW3Nkdywgc2RoXSA9IHNpZ25EaXNwbGF5U2l6ZVxuICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgIHd4LmNhbnZhc1RvVGVtcEZpbGVQYXRoKHtcbiAgICAgICAgeDogMCxcbiAgICAgICAgeTogMCxcbiAgICAgICAgd2lkdGg6IHNkdyxcbiAgICAgICAgaGVpZ2h0OiBzZGgsXG4gICAgICAgIHF1YWxpdHk6IDEsXG4gICAgICAgIGNhbnZhc0lkOiBgc2lnbi0ke3RoaXMuZGF0YS5jb25maWcuaWR9YCxcbiAgICAgICAgc3VjY2Vzcyh7IHRlbXBGaWxlUGF0aCB9KSB7XG4gICAgICAgICAgdGhhdC5zZXREYXRhKHtcbiAgICAgICAgICAgIHRlbXBTaWduVXJsOiB0ZW1wRmlsZVBhdGhcbiAgICAgICAgICB9KVxuICAgICAgICAgIHd4LmdldEltYWdlSW5mbyh7XG4gICAgICAgICAgICBzcmM6IHRlbXBGaWxlUGF0aCxcbiAgICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgICAgIHRoYXQuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdGVtcFNpemU6IFtyZXMud2lkdGgsIHJlcy5oZWlnaHRdXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmYWlsKCkge1xuICAgICAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSxcbiAgICAgICAgZmFpbChlcnIpIHtcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgICAgY29uc29sZS53YXJuKCd0ZW1wRmlsZVBhdGggZXJyb3I6JywgZXJyKVxuICAgICAgICB9XG4gICAgICB9LCB0aGlzKVxuICAgIH0sXG4gICAgLyoqIG9uVG91Y2hTdGFydCAqL1xuICAgIG9uVG91Y2hTdGFydChlKSB7XG4gICAgICBjb25zdCBbcG9zWCwgcG9zWV0gPSB0aGlzLmRhdGEucG9zXG4gICAgICBjb25zdCB7IHBhZ2VYLCBwYWdlWSB9ID0gZS50b3VjaGVzWzBdXG4gICAgICBjb25zdCB7IG9mZnNldExlZnQsIG9mZnNldFRvcCB9ID0gZS5jdXJyZW50VGFyZ2V0XG4gICAgICBjb25zdCB4ID0gfn4ocGFnZVggLSBvZmZzZXRMZWZ0KVxuICAgICAgY29uc3QgeSA9IH5+KHBhZ2VZIC0gb2Zmc2V0VG9wKVxuICAgICAgY29uc3QgW3Nkdywgc2RoXSA9IHRoaXMuZGF0YS5zaWduRGlzcGxheVNpemVcbiAgICAgIGxldCBpc01vdmluZ1NpZ24gPSBmYWxzZVxuICAgICAgaWYgKFxuICAgICAgICBwb3NYIDw9IHggJiZcbiAgICAgICAgeCA8PSBwb3NYICsgc2R3ICYmXG4gICAgICAgIHBvc1kgPD0geSAmJlxuICAgICAgICB5IDw9IHBvc1kgKyBzZGhcbiAgICAgICkge1xuICAgICAgICBpc01vdmluZ1NpZ24gPSB0cnVlXG4gICAgICB9XG4gICAgICBjb25zdCBbb2Zmc2V0WCwgb2Zmc2V0WV0gPSBbeCAtIHBvc1gsIHkgLSBwb3NZXVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgaXNNb3ZpbmdTaWduLFxuICAgICAgICBvZmZzZXQ6IFtvZmZzZXRYLCBvZmZzZXRZXSxcbiAgICAgICAgdG91Y2hUczogRGF0ZS5ub3coKSxcbiAgICAgICAgdG91Y2hQb3M6IFtwYWdlWCwgcGFnZVldLFxuICAgICAgfSlcbiAgICB9LFxuICAgIC8qKiBvblRvdWNoTW92ZSAqL1xuICAgIG9uVG91Y2hNb3ZlKGUpIHtcbiAgICAgIGlmICghdGhpcy5kYXRhLmlzTW92aW5nU2lnbikge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IFtvZmZzZXRYLCBvZmZzZXRZXSA9IHRoaXMuZGF0YS5vZmZzZXRcbiAgICAgIGNvbnN0IHggPSB+fihlLnRvdWNoZXNbMF0ucGFnZVggLSBlLmN1cnJlbnRUYXJnZXQub2Zmc2V0TGVmdClcbiAgICAgIGNvbnN0IHkgPSB+fihlLnRvdWNoZXNbMF0ucGFnZVkgLSBlLmN1cnJlbnRUYXJnZXQub2Zmc2V0VG9wKVxuICAgICAgY29uc3QgW3Nkdywgc2RoXSA9IHRoaXMuZGF0YS5zaWduRGlzcGxheVNpemVcbiAgICAgIGNvbnN0IFtjdywgY2hdID0gdGhpcy5kYXRhLmNvbnRhaW5lclNpemVcbiAgICAgIGxldCBbcG9zWCwgcG9zWV0gPSBbeCAtIG9mZnNldFgsIHkgLSBvZmZzZXRZXVxuICAgICAgcG9zWCA9IE1hdGgubWF4KDAsIHBvc1gpXG4gICAgICBwb3NYID0gTWF0aC5taW4oY3cgLSBzZHcsIHBvc1gpXG4gICAgICBwb3NZID0gTWF0aC5tYXgoMCwgcG9zWSlcbiAgICAgIHBvc1kgPSBNYXRoLm1pbihjaCAtIHNkaCwgcG9zWSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHBvczogW3Bvc1gsIHBvc1ldXG4gICAgICB9KVxuICAgIH0sXG4gICAgLyoqIG9uVG91Y2hFbmQgKi9cbiAgICBvblRvdWNoRW5kKGUpIHtcbiAgICAgIGNvbnN0IHsgcGFnZVgsIHBhZ2VZIH0gPSBlLmNoYW5nZWRUb3VjaGVzWzBdXG4gICAgICBjb25zdCB7IHRvdWNoVHMsIHRvdWNoUG9zIH0gPSB0aGlzLmRhdGFcbiAgICAgIGNvbnN0IGRpcyA9IE1hdGguc3FydChcbiAgICAgICAgTWF0aC5wb3coKHBhZ2VYIC0gdG91Y2hQb3NbMF0pLCAyKSArXG4gICAgICAgIE1hdGgucG93KChwYWdlWSAtIHRvdWNoUG9zWzFdKSwgMilcbiAgICAgIClcbiAgICAgIGlmIChEYXRlLm5vdygpIC0gdG91Y2hUcyA8IDMwMCAmJiBkaXMgPCAzMCkge1xuICAgICAgICB0aGlzLm9uU3dpdGNoUGFuZWwoKVxuICAgICAgfVxuICAgIH0sXG4gICAgLyoqIOmAieaLqeminOiJsiAqL1xuICAgIG9uUGlja0NvbG9yKHsgZGV0YWlsIH0pIHtcbiAgICAgIGxldCByZ2IgPSBbMCwgMCwgMF1cbiAgICAgIHRyeSB7XG4gICAgICAgIHJnYiA9IGRldGFpbC5yZXBsYWNlKCdyZ2IoJywgJycpLnJlcGxhY2UoJyknLCAnJykuc3BsaXQoJywnKS5tYXAoYyA9PiArYylcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdjb252ZXJ0IGNvbG9yIGVycm9yOicsIGUpXG4gICAgICB9XG4gICAgICB0aGlzLnJlbmRlclNpZ25JbWcocmdiKVxuICAgIH0sXG4gICAgLyoqIOa4suafk+etvuWQjeWbviAqL1xuICAgIHJlbmRlclNpZ25JbWcocmdiKSB7XG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5L+d5a2Y5LitJywgbWFzazogdHJ1ZSB9KVxuICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgIGNvbnN0IHBpeGVscyA9IGNvbG9yTWF0cml4RmlsdGVyKHRoaXMuc2lnbkRhdGEsIHJnYilcbiAgICAgIHd4LmNhbnZhc1B1dEltYWdlRGF0YSh7XG4gICAgICAgIGNhbnZhc0lkOiBgc2lnbi0ke3RoaXMuZGF0YS5jb25maWcuaWR9YCxcbiAgICAgICAgeDogMCxcbiAgICAgICAgeTogMCxcbiAgICAgICAgd2lkdGg6IHRoaXMuc2lnbkRhdGFTaXplWzBdLFxuICAgICAgICBoZWlnaHQ6IHRoaXMuc2lnbkRhdGFTaXplWzFdLFxuICAgICAgICBkYXRhOiBwaXhlbHMsXG4gICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgdGhhdC5vbkZpcnN0RHJhdygpXG4gICAgICAgIH1cbiAgICAgIH0sIHRoaXMpXG4gICAgfSxcbiAgICAvKiog54K55Ye75L+d5a2Y5oyJ6ZKuICovXG4gICAgb25TYXZlSW1nKCkge1xuICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+S/neWtmOS4rScsIG1hc2s6IHRydWUgfSlcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgYmFzZVNpemUsXG4gICAgICAgIHNpZ25TaXplLFxuICAgICAgICBjb250YWluZXJTaXplLFxuICAgICAgICB0ZW1wU2l6ZSxcbiAgICAgICAgcG9zLFxuICAgICAgfSA9IHRoaXMuZGF0YVxuICAgICAgY29uc3QgW2J3LCBiaF0gPSBiYXNlU2l6ZVxuICAgICAgY29uc3QgW3N3LCBzaF0gPSBzaWduU2l6ZVxuICAgICAgY29uc3QgW2N3XSA9IGNvbnRhaW5lclNpemVcbiAgICAgIGNvbnN0IFt0dywgdGhdID0gdGVtcFNpemVcbiAgICAgIGNvbnN0IHNjYWxlID0gY3cgLyBid1xuICAgICAgaWYgKHRoaXMuZGF0YS5iYXNlQ3R4KSB7XG4gICAgICAgIHRoaXMuZGF0YS5iYXNlQ3R4LmRyYXdJbWFnZSh0aGlzLmRhdGEuYmFzZVVybCwgMCwgMCwgYncsIGJoLCAwLCAwLCBidywgYmgpXG4gICAgICAgIC8qKiBcbiAgICAgICAgICog55CG6K665LiK5Y+C5pWwIDTvvIw1IOW6lOivpeaYryBzZHflkoxzd2jvvIzmqKHmi5/lmajkuZ/mmK9zZHflkoxzZGjvvIznnJ/mnLrlv4XpobvmoLnmja7kuLTml7blm77niYflrp7pmYXlsLrlr7jov5vooYzorr7nva5cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGF0YS5iYXNlQ3R4LmRyYXdJbWFnZSh0aGlzLmRhdGEudGVtcFNpZ25VcmwsIDAsIDAsIHR3LCB0aCwgfn4ocG9zWzBdIC8gc2NhbGUpLCB+fihwb3NbMV0gLyBzY2FsZSksIHN3LCBzaClcbiAgICAgICAgdGhpcy5kYXRhLmJhc2VDdHguZHJhdyhmYWxzZSwgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY29udmVydENhbnZhczJUZW1wRmlsZSgpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSxcbiAgICAvKiog5bCG5ZCI5oiQ5Zu+6L2s5o2i5Li65Li05pe25Zu+54mH5paH5Lu2ICovXG4gICAgY29udmVydENhbnZhczJUZW1wRmlsZSgpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgYmFzZVNpemVcbiAgICAgIH0gPSB0aGlzLmRhdGFcbiAgICAgIGNvbnN0IFtidywgYmhdID0gYmFzZVNpemVcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICB3eC5jYW52YXNUb1RlbXBGaWxlUGF0aCh7XG4gICAgICAgIHg6IDAsXG4gICAgICAgIHk6IDAsXG4gICAgICAgIHdpZHRoOiBidyxcbiAgICAgICAgaGVpZ2h0OiBiaCxcbiAgICAgICAgcXVhbGl0eTogMSxcbiAgICAgICAgY2FudmFzSWQ6IGBiYXNlLSR7dGhpcy5kYXRhLmNvbmZpZy5pZH1gLFxuICAgICAgICBzdWNjZXNzKHsgdGVtcEZpbGVQYXRoIH0pIHtcbiAgICAgICAgICB0aGF0LnNhdmVJbWFnZUZpbGUyQWxidW0odGVtcEZpbGVQYXRoKVxuICAgICAgICB9LFxuICAgICAgICBmYWlsKGVycikge1xuICAgICAgICAgIGNvbnNvbGUud2FybigndGVtcEZpbGVQYXRoIGVycm9yOicsIGVycilcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIH1cbiAgICAgIH0sIHRoaXMpXG4gICAgfSxcbiAgICAvKiog5L+d5a2Y5Zu+54mH5Yiw55u45YaMICovXG4gICAgc2F2ZUltYWdlRmlsZTJBbGJ1bShmaWxlUGF0aCkge1xuICAgICAgd3guc2F2ZUltYWdlVG9QaG90b3NBbGJ1bSh7XG4gICAgICAgIGZpbGVQYXRoLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+S/neWtmOaIkOWKnycsXG4gICAgICAgICAgICBpY29uOiAnc3VjY2VzcycsXG4gICAgICAgICAgICBkdXJhdGlvbjogMTAwMFxuICAgICAgICAgIH0pXG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBsZXRlKCkge1xuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9LFxuICAgIC8qKiDliIfmjaLosIPoibLmnb/mmL7npLrnirbmgIEgKi9cbiAgICBvblN3aXRjaFBhbmVsKCkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgc2hvd1BhbmVsOiAhdGhpcy5kYXRhLnNob3dQYW5lbFxuICAgICAgfSlcbiAgICB9LFxuICB9LFxuXG59KVxuIl19