"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const res_loader_1 = require("./utils/res-loader");
Component({
    properties: {
        book: {
            type: Number,
            value: 11
        }
    },
    data: {
        retry: 3,
        totalResCount: 1,
        progress: '0',
        loaded: false,
        hasVideo: false,
        current: 0,
        throttleFlag: 0,
        timeout: null,
        bgm: '',
        bgmLocal: '',
        cover: '',
        pages: [],
        pagesLocal: [],
        isVideoPlaying: false,
        videoStyle: 'left:1000px;',
        videoHeight: 300,
        videoSrc: ''
    },
    methods: {
        getMagazineData() {
            if (!this.data.book && !(this.data.book === 0)) {
                this.showNetError();
                return;
            }
            const that = this;
            wx.request({
                url: 'https://xgbapi.zcoming.com/api/magazine/show',
                method: 'POST',
                data: {
                    'magazine_id': this.data.book
                },
                success(res) {
                    const data = res.data.data;
                    that.setData({ magazine: data });
                    that.handleMagazineData();
                },
                fail(err) {
                    if (that.data.retry > 0) {
                        that.setData({ retry: that.data.retry - 1 });
                        setTimeout(() => {
                            that.getMagazineData();
                        }, 0);
                    }
                    else {
                        that.showNetError();
                    }
                }
            });
        },
        showNetError() {
            wx.showModal({
                title: '网络错误',
                content: '未获取到杂志信息',
                showCancel: false,
                confirmText: '返回',
                confirmColor: '#000000',
                success() {
                    wx.navigateBack({
                        delta: 1
                    });
                }
            });
        },
        handleMagazineData() {
            const { title, audio_url, tail_pic, page_join, } = this.data.magazine;
            wx.setNavigationBarTitle({
                title
            });
            this.setData({
                pages: page_join,
                bgm: audio_url,
                cover: tail_pic,
                isVideoPlaying: false,
                videoStyle: `left:${this.data.windowWidth}px;`,
            });
            this.initVideoContext();
            this.loadRes();
        },
        initVideoContext() {
            let hasVideo = false;
            this.data.pages.forEach(page => {
                if (page.type === 4 || page.type === 3) {
                    hasVideo = true;
                }
            });
            this.setData({
                hasVideo,
            });
            if (hasVideo) {
                this.videoContext = wx.createVideoContext('common-video', this);
            }
        },
        loadRes() {
            const pages = this.data.pages;
            let resList = [this.data.cover];
            if (this.data.bgm) {
                resList.push(this.data.bgm);
            }
            pages.forEach(page => {
                [
                    'pic',
                    'video_cover',
                    'base_pic',
                    'sign_pic',
                ].forEach(key => {
                    if (page[key]) {
                        resList.push(page[key]);
                    }
                });
                if (page.pic_join.length) {
                    page.pic_join.forEach(item => {
                        resList.push(item.pic);
                    });
                }
            });
            this.setData({
                totalResCount: resList.length
            });
            res_loader_1.loadRes(resList.concat(), this.onProgress, this.onResLoaded, this);
        },
        onProgress(current) {
            let total = this.data.totalResCount;
            let progress = Number(100 * current / total).toFixed(0);
            this.setData({ progress });
        },
        onResLoaded(loadedResList) {
            const getLocal = url => {
                for (let i = loadedResList.length - 1; i >= 0; i--) {
                    if (loadedResList[i].origin === url) {
                        return loadedResList[i].local;
                    }
                }
            };
            if (this.data.bgm) {
                const bgmLocal = getLocal(this.data.bgm);
                this.setData({ bgmLocal });
            }
            const pages = this.data.pages;
            let pagesLocal = JSON.parse(JSON.stringify(pages));
            pagesLocal.forEach(page => {
                [
                    'pic',
                    'video_cover',
                    'base_pic',
                    'sign_pic',
                ].forEach(key => {
                    if (page[key]) {
                        page[key] = getLocal(page[key]);
                    }
                });
                if (page.pic_join.length) {
                    page.pic_join.forEach(item => {
                        item.pic = getLocal(item.pic);
                    });
                }
            });
            this.setData({ pagesLocal, loaded: true });
            setTimeout(() => {
                this.selectComponent(`.layout-${this.data.current}`).setEnter();
            }, 0);
        },
        onFinish({ detail }) {
            let { current } = detail;
            let previous = this.data.current;
            if (previous !== current) {
                if (this.data.timeout) {
                    clearTimeout(this.data.timeout);
                    this.data.timeout = null;
                }
                this.data.timeout = setTimeout(() => {
                    this.selectComponent(`.layout-${previous}`).setExit();
                    this.selectComponent(`.layout-${current}`).setEnter();
                }, 0);
            }
            this.setData({ current });
        },
        onSwipe({ detail }) {
            this.setItemAnim(~~detail.dx);
            if (this.data.hasVideo) {
                this.stopPlay();
            }
        },
        setItemAnim(dx) {
            let sign = Math.sign(dx);
            let current = this.data.current;
            let next = sign + current;
            let step = Number(dx / this.data.windowWidth).toFixed(2);
            let abs = Math.abs(step);
            if (abs > 1) {
                let dis = sign * ~~abs;
                next += dis;
                current += dis;
                step -= dis;
            }
            if (0 <= next && next < this.data.pages.length) {
                this.selectComponent(`.layout-${next}`).setFrame(step, true);
            }
            this.selectComponent(`.layout-${current}`).setFrame(step, false);
        },
        onVideoPlay({ detail }) {
            const videoContext = this.videoContext;
            if (!videoContext) {
                this.setData({
                    isVideoPlaying: false
                });
                return;
            }
            let config = null;
            this.data.pagesLocal.forEach(page => {
                if (page.id === +detail) {
                    config = page;
                }
            });
            const { type, video_url, video_cover } = config;
            const videoHeight = this.data.videoHeight;
            const videoStyle = type === 3 ?
                'height:100vh;top:0px;margin-top:0px;' :
                `height:${videoHeight}px;margin-top:-${~~(videoHeight / 2)}px;`;
            this.setData({
                isVideoPlaying: true,
                videoSrc: video_url,
                videoCover: video_cover,
                videoStyle,
            });
            wx.nextTick(() => {
                videoContext.seek(0);
                videoContext.play();
            });
        },
        stopPlay() {
            let windowWidth = this.data.windowWidth;
            this.setData({
                isVideoPlaying: false,
                videoStyle: `left:${windowWidth}px;`,
            });
            if (this.videoContext) {
                this.videoContext.pause();
            }
        },
    },
    lifetimes: {
        attached() {
            let that = this;
            wx.getSystemInfo({
                success({ windowWidth, windowHeight }) {
                    const videoHeight = ~~(windowWidth * 9 / 16);
                    that.setData({
                        windowWidth,
                        windowHeight,
                        videoHeight
                    });
                }
            });
            wx.setNavigationBarTitle({
                title: '加载中'
            });
            this.getMagazineData();
        },
        detached() {
            this.setData({
                retry: 3,
                totalResCount: 1,
                progress: '0',
                loaded: false,
                hasVideo: false,
                current: 0,
                throttleFlag: 0,
                timeout: null,
                bgm: '',
                bgmLocal: '',
                cover: '',
                pages: [],
                pagesLocal: [],
                isVideoPlaying: false,
                videoStyle: 'left:1000px;',
                videoHeight: 300,
                videoSrc: ''
            });
        },
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQUE0QztBQUU1QyxTQUFTLENBQUM7SUFHUixVQUFVLEVBQUU7UUFDVixJQUFJLEVBQUU7WUFDSixJQUFJLEVBQUUsTUFBTTtZQUNaLEtBQUssRUFBRSxFQUFFO1NBQ1Y7S0FDRjtJQUdELElBQUksRUFBRTtRQUVKLEtBQUssRUFBRSxDQUFDO1FBRVIsYUFBYSxFQUFFLENBQUM7UUFFaEIsUUFBUSxFQUFFLEdBQUc7UUFFYixNQUFNLEVBQUUsS0FBSztRQUViLFFBQVEsRUFBRSxLQUFLO1FBRWYsT0FBTyxFQUFFLENBQUM7UUFFVixZQUFZLEVBQUUsQ0FBQztRQUVmLE9BQU8sRUFBRSxJQUFJO1FBRWIsR0FBRyxFQUFFLEVBQUU7UUFDUCxRQUFRLEVBQUUsRUFBRTtRQUVaLEtBQUssRUFBRSxFQUFFO1FBRVQsS0FBSyxFQUFFLEVBQUU7UUFDVCxVQUFVLEVBQUUsRUFBRTtRQUVkLGNBQWMsRUFBRSxLQUFLO1FBRXJCLFVBQVUsRUFBRSxjQUFjO1FBQzFCLFdBQVcsRUFBRSxHQUFHO1FBQ2hCLFFBQVEsRUFBRSxFQUFFO0tBQ2I7SUFHRCxPQUFPLEVBQUU7UUFFUCxlQUFlO1lBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO2dCQUNuQixPQUFNO2FBQ1A7WUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUE7WUFDakIsRUFBRSxDQUFDLE9BQU8sQ0FBQztnQkFDVCxHQUFHLEVBQUUsOENBQThDO2dCQUNuRCxNQUFNLEVBQUUsTUFBTTtnQkFDZCxJQUFJLEVBQUU7b0JBQ0osYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTtpQkFDOUI7Z0JBQ0QsT0FBTyxDQUFDLEdBQUc7b0JBQ1QsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUE7b0JBQzFCLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtvQkFDaEMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUE7Z0JBQzNCLENBQUM7Z0JBQ0QsSUFBSSxDQUFDLEdBQUc7b0JBQ04sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUU7d0JBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQTt3QkFDNUMsVUFBVSxDQUFDLEdBQUcsRUFBRTs0QkFDZCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7d0JBQ3hCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtxQkFDTjt5QkFBTTt3QkFDTCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7cUJBQ3BCO2dCQUNILENBQUM7YUFDRixDQUFDLENBQUE7UUFDSixDQUFDO1FBRUQsWUFBWTtZQUNWLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0JBQ1gsS0FBSyxFQUFFLE1BQU07Z0JBQ2IsT0FBTyxFQUFFLFVBQVU7Z0JBQ25CLFVBQVUsRUFBRSxLQUFLO2dCQUNqQixXQUFXLEVBQUUsSUFBSTtnQkFDakIsWUFBWSxFQUFFLFNBQVM7Z0JBQ3ZCLE9BQU87b0JBQ0wsRUFBRSxDQUFDLFlBQVksQ0FBQzt3QkFDZCxLQUFLLEVBQUUsQ0FBQztxQkFDVCxDQUFDLENBQUE7Z0JBQ0osQ0FBQzthQUNGLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFFRCxrQkFBa0I7WUFDaEIsTUFBTSxFQUVKLEtBQUssRUFDTCxTQUFTLEVBQ1QsUUFBUSxFQUNSLFNBQVMsR0FDVixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFBO1lBQ3RCLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQztnQkFDdkIsS0FBSzthQUNOLENBQUMsQ0FBQTtZQUNGLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLEdBQUcsRUFBRSxTQUFTO2dCQUNkLEtBQUssRUFBRSxRQUFRO2dCQUNmLGNBQWMsRUFBRSxLQUFLO2dCQUNyQixVQUFVLEVBQUUsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsS0FBSzthQUMvQyxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtZQUN2QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDaEIsQ0FBQztRQUVELGdCQUFnQjtZQUNkLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQTtZQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzdCLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUU7b0JBQ3RDLFFBQVEsR0FBRyxJQUFJLENBQUE7aUJBQ2hCO1lBQ0gsQ0FBQyxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLFFBQVE7YUFDVCxDQUFDLENBQUE7WUFDRixJQUFJLFFBQVEsRUFBRTtnQkFDWixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUE7YUFDaEU7UUFDSCxDQUFDO1FBRUQsT0FBTztZQUNMLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBbUIsQ0FBQTtZQUMzQyxJQUFJLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDL0IsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDakIsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQzVCO1lBQ0QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDbkI7b0JBQ0UsS0FBSztvQkFDTCxhQUFhO29CQUNiLFVBQVU7b0JBQ1YsVUFBVTtpQkFFWCxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtvQkFDZCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTt3QkFDYixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO3FCQUN4QjtnQkFDSCxDQUFDLENBQUMsQ0FBQTtnQkFDRixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO29CQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTt3QkFDM0IsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7b0JBQ3hCLENBQUMsQ0FBQyxDQUFBO2lCQUNIO1lBQ0gsQ0FBQyxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLGFBQWEsRUFBRSxPQUFPLENBQUMsTUFBTTthQUM5QixDQUFDLENBQUE7WUFDRixvQkFBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDcEUsQ0FBQztRQUNELFVBQVUsQ0FBQyxPQUFPO1lBQ2hCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFBO1lBQ25DLElBQUksUUFBUSxHQUFHLE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxHQUFHLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUN2RCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtRQUM1QixDQUFDO1FBRUQsV0FBVyxDQUFDLGFBQXVDO1lBQ2pELE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxFQUFFO2dCQUNyQixLQUFLLElBQUksQ0FBQyxHQUFHLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2xELElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7d0JBQ25DLE9BQU8sYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQTtxQkFDOUI7aUJBQ0Y7WUFDSCxDQUFDLENBQUE7WUFDRCxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNqQixNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7YUFDM0I7WUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtZQUM3QixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtZQUNsRCxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN4QjtvQkFDRSxLQUFLO29CQUNMLGFBQWE7b0JBQ2IsVUFBVTtvQkFDVixVQUFVO2lCQUVYLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUNkLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO3dCQUNiLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7cUJBQ2hDO2dCQUNILENBQUMsQ0FBQyxDQUFBO2dCQUNGLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUU7b0JBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUMzQixJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7b0JBQy9CLENBQUMsQ0FBQyxDQUFBO2lCQUNIO1lBQ0gsQ0FBQyxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1lBQzFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUNqRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDUCxDQUFDO1FBRUQsUUFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFO1lBQ2pCLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxNQUFNLENBQUE7WUFDeEIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUE7WUFDaEMsSUFBSSxRQUFRLEtBQUssT0FBTyxFQUFFO2dCQUN4QixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO29CQUNyQixZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtvQkFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFBO2lCQUN6QjtnQkFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO29CQUVsQyxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsUUFBUSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtvQkFFckQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLE9BQU8sRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUE7Z0JBQ3ZELENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTthQUNOO1lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7UUFDM0IsQ0FBQztRQU9ELE9BQU8sQ0FBQyxFQUFFLE1BQU0sRUFBRTtZQUNoQixJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDN0IsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO2FBQ2hCO1FBQ0gsQ0FBQztRQUVELFdBQVcsQ0FBQyxFQUFFO1lBQ1osSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUN4QixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQTtZQUMvQixJQUFJLElBQUksR0FBRyxJQUFJLEdBQUcsT0FBTyxDQUFBO1lBQ3pCLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDeEQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUl4QixJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsSUFBSSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUE7Z0JBQ3RCLElBQUksSUFBSSxHQUFHLENBQUE7Z0JBQ1gsT0FBTyxJQUFJLEdBQUcsQ0FBQTtnQkFDZCxJQUFJLElBQUksR0FBRyxDQUFBO2FBQ1o7WUFDRCxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtnQkFDOUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTthQUM3RDtZQUNELElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxPQUFPLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDbEUsQ0FBQztRQUVELFdBQVcsQ0FBQyxFQUFFLE1BQU0sRUFBRTtZQUNwQixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFBO1lBQ3RDLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ2pCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsY0FBYyxFQUFFLEtBQUs7aUJBQ3RCLENBQUMsQ0FBQTtnQkFDRixPQUFNO2FBQ1A7WUFFRCxJQUFJLE1BQU0sR0FBUSxJQUFJLENBQUE7WUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNsQyxJQUFJLElBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUU7b0JBQ3ZCLE1BQU0sR0FBRyxJQUFJLENBQUE7aUJBQ2Q7WUFDSCxDQUFDLENBQUMsQ0FBQTtZQUNGLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxHQUFHLE1BQU0sQ0FBQTtZQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQTtZQUN6QyxNQUFNLFVBQVUsR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQzdCLHNDQUFzQyxDQUFDLENBQUM7Z0JBQ3hDLFVBQVUsV0FBVyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUE7WUFDakUsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxjQUFjLEVBQUUsSUFBSTtnQkFDcEIsUUFBUSxFQUFFLFNBQVM7Z0JBQ25CLFVBQVUsRUFBRSxXQUFXO2dCQUN2QixVQUFVO2FBQ1gsQ0FBQyxDQUFBO1lBQ0YsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2YsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDcEIsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFBO1lBQ3JCLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELFFBQVE7WUFDTixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQTtZQUN2QyxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUVYLGNBQWMsRUFBRSxLQUFLO2dCQUVyQixVQUFVLEVBQUUsUUFBUSxXQUFXLEtBQUs7YUFDckMsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO2dCQUNyQixJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFBO2FBQzFCO1FBQ0gsQ0FBQztLQUNGO0lBR0QsU0FBUyxFQUFFO1FBRVQsUUFBUTtZQUNOLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQTtZQUVmLEVBQUUsQ0FBQyxhQUFhLENBQUM7Z0JBQ2YsT0FBTyxDQUFDLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRTtvQkFDbkMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQTtvQkFDNUMsSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxXQUFXO3dCQUNYLFlBQVk7d0JBQ1osV0FBVztxQkFDWixDQUFDLENBQUE7Z0JBQ0osQ0FBQzthQUNGLENBQUMsQ0FBQTtZQUNGLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQztnQkFDdkIsS0FBSyxFQUFFLEtBQUs7YUFDYixDQUFDLENBQUE7WUFFRixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7UUFDeEIsQ0FBQztRQUNELFFBQVE7WUFDTixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUVYLEtBQUssRUFBRSxDQUFDO2dCQUVSLGFBQWEsRUFBRSxDQUFDO2dCQUVoQixRQUFRLEVBQUUsR0FBRztnQkFFYixNQUFNLEVBQUUsS0FBSztnQkFFYixRQUFRLEVBQUUsS0FBSztnQkFFZixPQUFPLEVBQUUsQ0FBQztnQkFFVixZQUFZLEVBQUUsQ0FBQztnQkFFZixPQUFPLEVBQUUsSUFBSTtnQkFFYixHQUFHLEVBQUUsRUFBRTtnQkFDUCxRQUFRLEVBQUUsRUFBRTtnQkFFWixLQUFLLEVBQUUsRUFBRTtnQkFFVCxLQUFLLEVBQUUsRUFBRTtnQkFDVCxVQUFVLEVBQUUsRUFBRTtnQkFFZCxjQUFjLEVBQUUsS0FBSztnQkFFckIsVUFBVSxFQUFFLGNBQWM7Z0JBQzFCLFdBQVcsRUFBRSxHQUFHO2dCQUNoQixRQUFRLEVBQUUsRUFBRTthQUNiLENBQUMsQ0FBQTtRQUNKLENBQUM7S0FDRjtDQUVGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvYWRSZXMgfSBmcm9tICcuL3V0aWxzL3Jlcy1sb2FkZXInXG5cbkNvbXBvbmVudCh7XG5cbiAgLyoqIOe7hOS7tueahOWxnuaAp+WIl+ihqCAqL1xuICBwcm9wZXJ0aWVzOiB7XG4gICAgYm9vazoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgdmFsdWU6IDExXG4gICAgfVxuICB9LFxuXG4gIC8qKiDnu4Tku7bnmoTliJ3lp4vmlbDmja4gKi9cbiAgZGF0YToge1xuICAgIC8qKiByZXRyeSAqL1xuICAgIHJldHJ5OiAzLFxuICAgIC8qKiDotYTmupDmgLvmlbAgKi9cbiAgICB0b3RhbFJlc0NvdW50OiAxLFxuICAgIC8qKiDotYTmupDliqDovb3ov5vluqYgKi9cbiAgICBwcm9ncmVzczogJzAnLFxuICAgIC8qKiDotYTmupDmmK/lkKbliqDovb3lrozmr5UgKi9cbiAgICBsb2FkZWQ6IGZhbHNlLFxuICAgIC8qKiDmmK/lkKblrZjlnKh2aWRlbyAqL1xuICAgIGhhc1ZpZGVvOiBmYWxzZSxcbiAgICAvKiog5b2T5YmNbGF5b3V05LiL5qCHICovXG4gICAgY3VycmVudDogMCxcbiAgICAvKiog5ruR5Yqo5Ye95pWw6IqC5rWB5qCH6K6wICovXG4gICAgdGhyb3R0bGVGbGFnOiAwLFxuICAgIC8qKiDpobXpnaLliIfmjaJ0aW1lb3V05qCH6K6wICovXG4gICAgdGltZW91dDogbnVsbCxcbiAgICAvKiogYmdt5Zyw5Z2AICovXG4gICAgYmdtOiAnJyxcbiAgICBiZ21Mb2NhbDogJycsXG4gICAgLyoqIOWwgemdouWcsOWdgCAqL1xuICAgIGNvdmVyOiAnJyxcbiAgICAvKiogbGF5b3V05L+h5oGv5pWw57uEICovXG4gICAgcGFnZXM6IFtdLFxuICAgIHBhZ2VzTG9jYWw6IFtdLFxuICAgIC8qKiDmmK/lkKblnKjmkq3mlL7op4bpopEgKi9cbiAgICBpc1ZpZGVvUGxheWluZzogZmFsc2UsXG4gICAgLyoqIOinhumikeagt+W8jyAqL1xuICAgIHZpZGVvU3R5bGU6ICdsZWZ0OjEwMDBweDsnLFxuICAgIHZpZGVvSGVpZ2h0OiAzMDAsXG4gICAgdmlkZW9TcmM6ICcnXG4gIH0sXG5cbiAgLyoqIOe7hOS7tueahOaWueazleWIl+ihqCAqL1xuICBtZXRob2RzOiB7XG4gICAgLyoqIOiOt+WPluadguW/l+S/oeaBryAqL1xuICAgIGdldE1hZ2F6aW5lRGF0YSgpIHtcbiAgICAgIGlmICghdGhpcy5kYXRhLmJvb2sgJiYgISh0aGlzLmRhdGEuYm9vayA9PT0gMCkpIHtcbiAgICAgICAgdGhpcy5zaG93TmV0RXJyb3IoKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICB3eC5yZXF1ZXN0KHtcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly94Z2JhcGkuemNvbWluZy5jb20vYXBpL21hZ2F6aW5lL3Nob3cnLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgICdtYWdhemluZV9pZCc6IHRoaXMuZGF0YS5ib29rXG4gICAgICAgIH0sXG4gICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5kYXRhLmRhdGFcbiAgICAgICAgICB0aGF0LnNldERhdGEoeyBtYWdhemluZTogZGF0YSB9KVxuICAgICAgICAgIHRoYXQuaGFuZGxlTWFnYXppbmVEYXRhKClcbiAgICAgICAgfSxcbiAgICAgICAgZmFpbChlcnIpIHtcbiAgICAgICAgICBpZiAodGhhdC5kYXRhLnJldHJ5ID4gMCkge1xuICAgICAgICAgICAgdGhhdC5zZXREYXRhKHsgcmV0cnk6IHRoYXQuZGF0YS5yZXRyeSAtIDEgfSlcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICB0aGF0LmdldE1hZ2F6aW5lRGF0YSgpXG4gICAgICAgICAgICB9LCAwKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGF0LnNob3dOZXRFcnJvcigpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0sXG4gICAgLyoqIOe9kee7nOaVhemanCAqL1xuICAgIHNob3dOZXRFcnJvcigpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn572R57uc6ZSZ6K+vJyxcbiAgICAgICAgY29udGVudDogJ+acquiOt+WPluWIsOadguW/l+S/oeaBrycsXG4gICAgICAgIHNob3dDYW5jZWw6IGZhbHNlLFxuICAgICAgICBjb25maXJtVGV4dDogJ+i/lOWbnicsXG4gICAgICAgIGNvbmZpcm1Db2xvcjogJyMwMDAwMDAnLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgICAgICAgICBkZWx0YTogMVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSxcbiAgICAvKiog5aSE55CG5p2C5b+X5pWw5o2u5Lul5L6/5riy5p+TICovXG4gICAgaGFuZGxlTWFnYXppbmVEYXRhKCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICAvLyBpZCxcbiAgICAgICAgdGl0bGUsXG4gICAgICAgIGF1ZGlvX3VybCxcbiAgICAgICAgdGFpbF9waWMsXG4gICAgICAgIHBhZ2Vfam9pbixcbiAgICAgIH0gPSB0aGlzLmRhdGEubWFnYXppbmVcbiAgICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7XG4gICAgICAgIHRpdGxlXG4gICAgICB9KVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGFnZXM6IHBhZ2Vfam9pbixcbiAgICAgICAgYmdtOiBhdWRpb191cmwsXG4gICAgICAgIGNvdmVyOiB0YWlsX3BpYyxcbiAgICAgICAgaXNWaWRlb1BsYXlpbmc6IGZhbHNlLFxuICAgICAgICB2aWRlb1N0eWxlOiBgbGVmdDoke3RoaXMuZGF0YS53aW5kb3dXaWR0aH1weDtgLFxuICAgICAgfSlcbiAgICAgIHRoaXMuaW5pdFZpZGVvQ29udGV4dCgpXG4gICAgICB0aGlzLmxvYWRSZXMoKVxuICAgIH0sXG4gICAgLyoqIOWIneWni+WMluinhumikeS4iuS4i+aWhyAqL1xuICAgIGluaXRWaWRlb0NvbnRleHQoKSB7XG4gICAgICBsZXQgaGFzVmlkZW8gPSBmYWxzZVxuICAgICAgdGhpcy5kYXRhLnBhZ2VzLmZvckVhY2gocGFnZSA9PiB7XG4gICAgICAgIGlmIChwYWdlLnR5cGUgPT09IDQgfHwgcGFnZS50eXBlID09PSAzKSB7XG4gICAgICAgICAgaGFzVmlkZW8gPSB0cnVlXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBoYXNWaWRlbyxcbiAgICAgIH0pXG4gICAgICBpZiAoaGFzVmlkZW8pIHtcbiAgICAgICAgdGhpcy52aWRlb0NvbnRleHQgPSB3eC5jcmVhdGVWaWRlb0NvbnRleHQoJ2NvbW1vbi12aWRlbycsIHRoaXMpXG4gICAgICB9XG4gICAgfSxcbiAgICAvKiog6aKE5Yqg6L295Zu+54mH6LWE5rqQICovXG4gICAgbG9hZFJlcygpIHtcbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5kYXRhLnBhZ2VzIGFzIEFycmF5PGFueT5cbiAgICAgIGxldCByZXNMaXN0ID0gW3RoaXMuZGF0YS5jb3Zlcl1cbiAgICAgIGlmICh0aGlzLmRhdGEuYmdtKSB7XG4gICAgICAgIHJlc0xpc3QucHVzaCh0aGlzLmRhdGEuYmdtKVxuICAgICAgfVxuICAgICAgcGFnZXMuZm9yRWFjaChwYWdlID0+IHtcbiAgICAgICAgW1xuICAgICAgICAgICdwaWMnLFxuICAgICAgICAgICd2aWRlb19jb3ZlcicsXG4gICAgICAgICAgJ2Jhc2VfcGljJyxcbiAgICAgICAgICAnc2lnbl9waWMnLFxuICAgICAgICAgIC8vICd2aWRlb191cmwnLFxuICAgICAgICBdLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICBpZiAocGFnZVtrZXldKSB7XG4gICAgICAgICAgICByZXNMaXN0LnB1c2gocGFnZVtrZXldKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgaWYgKHBhZ2UucGljX2pvaW4ubGVuZ3RoKSB7XG4gICAgICAgICAgcGFnZS5waWNfam9pbi5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgcmVzTGlzdC5wdXNoKGl0ZW0ucGljKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICB0b3RhbFJlc0NvdW50OiByZXNMaXN0Lmxlbmd0aFxuICAgICAgfSlcbiAgICAgIGxvYWRSZXMocmVzTGlzdC5jb25jYXQoKSwgdGhpcy5vblByb2dyZXNzLCB0aGlzLm9uUmVzTG9hZGVkLCB0aGlzKVxuICAgIH0sXG4gICAgb25Qcm9ncmVzcyhjdXJyZW50KSB7XG4gICAgICBsZXQgdG90YWwgPSB0aGlzLmRhdGEudG90YWxSZXNDb3VudFxuICAgICAgbGV0IHByb2dyZXNzID0gTnVtYmVyKDEwMCAqIGN1cnJlbnQgLyB0b3RhbCkudG9GaXhlZCgwKVxuICAgICAgdGhpcy5zZXREYXRhKHsgcHJvZ3Jlc3MgfSlcbiAgICB9LFxuICAgIC8qKiDlm77niYfpooTliqDovb3lrozmr5UgKi9cbiAgICBvblJlc0xvYWRlZChsb2FkZWRSZXNMaXN0OiBBcnJheTx7IG9yaWdpbiwgbG9jYWwgfT4pIHtcbiAgICAgIGNvbnN0IGdldExvY2FsID0gdXJsID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IGxvYWRlZFJlc0xpc3QubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICBpZiAobG9hZGVkUmVzTGlzdFtpXS5vcmlnaW4gPT09IHVybCkge1xuICAgICAgICAgICAgcmV0dXJuIGxvYWRlZFJlc0xpc3RbaV0ubG9jYWxcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmRhdGEuYmdtKSB7XG4gICAgICAgIGNvbnN0IGJnbUxvY2FsID0gZ2V0TG9jYWwodGhpcy5kYXRhLmJnbSlcbiAgICAgICAgdGhpcy5zZXREYXRhKHsgYmdtTG9jYWwgfSlcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5kYXRhLnBhZ2VzXG4gICAgICBsZXQgcGFnZXNMb2NhbCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocGFnZXMpKVxuICAgICAgcGFnZXNMb2NhbC5mb3JFYWNoKHBhZ2UgPT4ge1xuICAgICAgICBbXG4gICAgICAgICAgJ3BpYycsXG4gICAgICAgICAgJ3ZpZGVvX2NvdmVyJyxcbiAgICAgICAgICAnYmFzZV9waWMnLFxuICAgICAgICAgICdzaWduX3BpYycsXG4gICAgICAgICAgLy8gJ3ZpZGVvX3VybCcsXG4gICAgICAgIF0uZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgIGlmIChwYWdlW2tleV0pIHtcbiAgICAgICAgICAgIHBhZ2Vba2V5XSA9IGdldExvY2FsKHBhZ2Vba2V5XSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIGlmIChwYWdlLnBpY19qb2luLmxlbmd0aCkge1xuICAgICAgICAgIHBhZ2UucGljX2pvaW4uZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICAgIGl0ZW0ucGljID0gZ2V0TG9jYWwoaXRlbS5waWMpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7IHBhZ2VzTG9jYWwsIGxvYWRlZDogdHJ1ZSB9KVxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KGAubGF5b3V0LSR7dGhpcy5kYXRhLmN1cnJlbnR9YCkuc2V0RW50ZXIoKVxuICAgICAgfSwgMClcbiAgICB9LFxuICAgIC8qKiBzd2lwZXLliIfmjaLkuovku7YgKi9cbiAgICBvbkZpbmlzaCh7IGRldGFpbCB9KSB7XG4gICAgICBsZXQgeyBjdXJyZW50IH0gPSBkZXRhaWxcbiAgICAgIGxldCBwcmV2aW91cyA9IHRoaXMuZGF0YS5jdXJyZW50XG4gICAgICBpZiAocHJldmlvdXMgIT09IGN1cnJlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YS50aW1lb3V0KSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZGF0YS50aW1lb3V0KVxuICAgICAgICAgIHRoaXMuZGF0YS50aW1lb3V0ID0gbnVsbFxuICAgICAgICB9XG4gICAgICAgIC8vIHRpbWVvdXTlsZ7mgKfkuI3lj4LkuI7muLLmn5PvvIzlm6DmraTph4fnlKjnm7TmjqXotYvlgLznmoTmlrnlvI9cbiAgICAgICAgdGhpcy5kYXRhLnRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAvLyBzZXRFeGl0XG4gICAgICAgICAgdGhpcy5zZWxlY3RDb21wb25lbnQoYC5sYXlvdXQtJHtwcmV2aW91c31gKS5zZXRFeGl0KClcbiAgICAgICAgICAvLyBzZXRFbnRlclxuICAgICAgICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KGAubGF5b3V0LSR7Y3VycmVudH1gKS5zZXRFbnRlcigpXG4gICAgICAgIH0sIDApXG4gICAgICB9XG4gICAgICB0aGlzLnNldERhdGEoeyBjdXJyZW50IH0pXG4gICAgfSxcbiAgICAvKiogXG4gICAgICogc3dpcGVy5ruR5Yqo5LqL5Lu2XG4gICAgICogQGRhdGUgMjAxOS0xMC0yNFxuICAgICAqIEBhdXRob3IgY2hlbmd4dTE5NzNcbiAgICAgKiBAZGVzYyDph4fnlKjlkITnp43oioLmtYHmlrnms5XnmoTnnJ/mnLrmu5HliqjmlYjmnpzpg73kuI3lpb3vvIzlm6DmraTmmoLml7bkuI3oioLmtYFcbiAgICAgKi9cbiAgICBvblN3aXBlKHsgZGV0YWlsIH0pIHtcbiAgICAgIHRoaXMuc2V0SXRlbUFuaW0ofn5kZXRhaWwuZHgpXG4gICAgICBpZiAodGhpcy5kYXRhLmhhc1ZpZGVvKSB7XG4gICAgICAgIHRoaXMuc3RvcFBsYXkoKVxuICAgICAgfVxuICAgIH0sXG4gICAgLyoqIHN3aXBlcua7keWKqOS6i+S7tuiKgua1geWQjuWTjeW6lCAqL1xuICAgIHNldEl0ZW1BbmltKGR4KSB7XG4gICAgICBsZXQgc2lnbiA9IE1hdGguc2lnbihkeClcbiAgICAgIGxldCBjdXJyZW50ID0gdGhpcy5kYXRhLmN1cnJlbnRcbiAgICAgIGxldCBuZXh0ID0gc2lnbiArIGN1cnJlbnRcbiAgICAgIGxldCBzdGVwID0gTnVtYmVyKGR4IC8gdGhpcy5kYXRhLndpbmRvd1dpZHRoKS50b0ZpeGVkKDIpXG4gICAgICBsZXQgYWJzID0gTWF0aC5hYnMoc3RlcClcbiAgICAgIC8vIOW9k+WJjemhtemdoua7keWKqOacquWujOaIkOeahOaXtuWAmee7p+e7rea7keWKqOWPr+iDveWHuueOsHN0ZXDnu53lr7nlgLzlpKfkuo7kuIDnmoTmg4XlhrVcbiAgICAgIC8vIOatpOaXtmJpbmRhbmltYXRpb25maW5pc2jkuovku7blsJrmnKrop6blj5HvvIxjdXJyZW505pyq5pS55Y+YXG4gICAgICAvLyDpnIDopoHorqHnrpflvZPliY3mmL7npLrpobXpnaLnmoRpbmRleOi/m+ihjOa4suafk1xuICAgICAgaWYgKGFicyA+IDEpIHtcbiAgICAgICAgbGV0IGRpcyA9IHNpZ24gKiB+fmFic1xuICAgICAgICBuZXh0ICs9IGRpc1xuICAgICAgICBjdXJyZW50ICs9IGRpc1xuICAgICAgICBzdGVwIC09IGRpc1xuICAgICAgfVxuICAgICAgaWYgKDAgPD0gbmV4dCAmJiBuZXh0IDwgdGhpcy5kYXRhLnBhZ2VzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnNlbGVjdENvbXBvbmVudChgLmxheW91dC0ke25leHR9YCkuc2V0RnJhbWUoc3RlcCwgdHJ1ZSlcbiAgICAgIH1cbiAgICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KGAubGF5b3V0LSR7Y3VycmVudH1gKS5zZXRGcmFtZShzdGVwLCBmYWxzZSlcbiAgICB9LFxuICAgIC8qKiDlrZDnu4Tku7bop4bpopHmkq3mlL4gKi9cbiAgICBvblZpZGVvUGxheSh7IGRldGFpbCB9KSB7XG4gICAgICBjb25zdCB2aWRlb0NvbnRleHQgPSB0aGlzLnZpZGVvQ29udGV4dFxuICAgICAgaWYgKCF2aWRlb0NvbnRleHQpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBpc1ZpZGVvUGxheWluZzogZmFsc2VcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICAvLyDojrflj5bop4bpopHkv6Hmga9cbiAgICAgIGxldCBjb25maWc6IGFueSA9IG51bGxcbiAgICAgIHRoaXMuZGF0YS5wYWdlc0xvY2FsLmZvckVhY2gocGFnZSA9PiB7XG4gICAgICAgIGlmIChwYWdlLmlkID09PSArZGV0YWlsKSB7XG4gICAgICAgICAgY29uZmlnID0gcGFnZVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgY29uc3QgeyB0eXBlLCB2aWRlb191cmwsIHZpZGVvX2NvdmVyIH0gPSBjb25maWdcbiAgICAgIGNvbnN0IHZpZGVvSGVpZ2h0ID0gdGhpcy5kYXRhLnZpZGVvSGVpZ2h0XG4gICAgICBjb25zdCB2aWRlb1N0eWxlID0gdHlwZSA9PT0gMyA/XG4gICAgICAgICdoZWlnaHQ6MTAwdmg7dG9wOjBweDttYXJnaW4tdG9wOjBweDsnIDpcbiAgICAgICAgYGhlaWdodDoke3ZpZGVvSGVpZ2h0fXB4O21hcmdpbi10b3A6LSR7fn4odmlkZW9IZWlnaHQgLyAyKX1weDtgXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBpc1ZpZGVvUGxheWluZzogdHJ1ZSxcbiAgICAgICAgdmlkZW9TcmM6IHZpZGVvX3VybCxcbiAgICAgICAgdmlkZW9Db3ZlcjogdmlkZW9fY292ZXIsXG4gICAgICAgIHZpZGVvU3R5bGUsXG4gICAgICB9KVxuICAgICAgd3gubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICB2aWRlb0NvbnRleHQuc2VlaygwKVxuICAgICAgICB2aWRlb0NvbnRleHQucGxheSgpXG4gICAgICB9KVxuICAgIH0sXG4gICAgc3RvcFBsYXkoKSB7XG4gICAgICBsZXQgd2luZG93V2lkdGggPSB0aGlzLmRhdGEud2luZG93V2lkdGhcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIC8qKiDmmK/lkKblnKjmkq3mlL7op4bpopEgKi9cbiAgICAgICAgaXNWaWRlb1BsYXlpbmc6IGZhbHNlLFxuICAgICAgICAvKiog6KeG6aKR5qC35byPICovXG4gICAgICAgIHZpZGVvU3R5bGU6IGBsZWZ0OiR7d2luZG93V2lkdGh9cHg7YCxcbiAgICAgIH0pXG4gICAgICBpZiAodGhpcy52aWRlb0NvbnRleHQpIHtcbiAgICAgICAgdGhpcy52aWRlb0NvbnRleHQucGF1c2UoKVxuICAgICAgfVxuICAgIH0sXG4gIH0sXG5cbiAgLyoqIOe7hOS7tueUn+WRveWRqOacn+WLvuWtkCAqL1xuICBsaWZldGltZXM6IHtcbiAgICAvLyDmt7vliqDliLDoiJ7lj7DliJ3lp4vljJbkuovku7ZcbiAgICBhdHRhY2hlZCgpIHtcbiAgICAgIGxldCB0aGF0ID0gdGhpc1xuICAgICAgLy8g6I635Y+W5bGP5bmV5bC65a+4XG4gICAgICB3eC5nZXRTeXN0ZW1JbmZvKHtcbiAgICAgICAgc3VjY2Vzcyh7IHdpbmRvd1dpZHRoLCB3aW5kb3dIZWlnaHQgfSkge1xuICAgICAgICAgIGNvbnN0IHZpZGVvSGVpZ2h0ID0gfn4od2luZG93V2lkdGggKiA5IC8gMTYpXG4gICAgICAgICAgdGhhdC5zZXREYXRhKHtcbiAgICAgICAgICAgIHdpbmRvd1dpZHRoLFxuICAgICAgICAgICAgd2luZG93SGVpZ2h0LFxuICAgICAgICAgICAgdmlkZW9IZWlnaHRcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgd3guc2V0TmF2aWdhdGlvbkJhclRpdGxlKHtcbiAgICAgICAgdGl0bGU6ICfliqDovb3kuK0nXG4gICAgICB9KVxuICAgICAgLy8g6I635Y+W5p2C5b+X5L+h5oGvXG4gICAgICB0aGlzLmdldE1hZ2F6aW5lRGF0YSgpXG4gICAgfSxcbiAgICBkZXRhY2hlZCgpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIC8qKiByZXRyeSAqL1xuICAgICAgICByZXRyeTogMyxcbiAgICAgICAgLyoqIOi1hOa6kOaAu+aVsCAqL1xuICAgICAgICB0b3RhbFJlc0NvdW50OiAxLFxuICAgICAgICAvKiog6LWE5rqQ5Yqg6L296L+b5bqmICovXG4gICAgICAgIHByb2dyZXNzOiAnMCcsXG4gICAgICAgIC8qKiDotYTmupDmmK/lkKbliqDovb3lrozmr5UgKi9cbiAgICAgICAgbG9hZGVkOiBmYWxzZSxcbiAgICAgICAgLyoqIOaYr+WQpuWtmOWcqHZpZGVvICovXG4gICAgICAgIGhhc1ZpZGVvOiBmYWxzZSxcbiAgICAgICAgLyoqIOW9k+WJjWxheW91dOS4i+aghyAqL1xuICAgICAgICBjdXJyZW50OiAwLFxuICAgICAgICAvKiog5ruR5Yqo5Ye95pWw6IqC5rWB5qCH6K6wICovXG4gICAgICAgIHRocm90dGxlRmxhZzogMCxcbiAgICAgICAgLyoqIOmhtemdouWIh+aNonRpbWVvdXTmoIforrAgKi9cbiAgICAgICAgdGltZW91dDogbnVsbCxcbiAgICAgICAgLyoqIGJnbeWcsOWdgCAqL1xuICAgICAgICBiZ206ICcnLFxuICAgICAgICBiZ21Mb2NhbDogJycsXG4gICAgICAgIC8qKiDlsIHpnaLlnLDlnYAgKi9cbiAgICAgICAgY292ZXI6ICcnLFxuICAgICAgICAvKiogbGF5b3V05L+h5oGv5pWw57uEICovXG4gICAgICAgIHBhZ2VzOiBbXSxcbiAgICAgICAgcGFnZXNMb2NhbDogW10sXG4gICAgICAgIC8qKiDmmK/lkKblnKjmkq3mlL7op4bpopEgKi9cbiAgICAgICAgaXNWaWRlb1BsYXlpbmc6IGZhbHNlLFxuICAgICAgICAvKiog6KeG6aKR5qC35byPICovXG4gICAgICAgIHZpZGVvU3R5bGU6ICdsZWZ0OjEwMDBweDsnLFxuICAgICAgICB2aWRlb0hlaWdodDogMzAwLFxuICAgICAgICB2aWRlb1NyYzogJydcbiAgICAgIH0pXG4gICAgfSxcbiAgfVxuXG59KVxuIl19