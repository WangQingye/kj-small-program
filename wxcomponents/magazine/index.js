"use strict";
Object.defineProperty(exports, "__esModule", {
	value: true
});
const res_loader_1 = require("./utils/res-loader");
Component({
	properties: {
		book: {
			type: Number,
			value: 11
		}
	},
	data: {
		retry: 3,
		totalResCount: 1,
		progress: '0',
		loaded: false,
		hasVideo: false,
		current: 0,
		throttleFlag: 0,
		timeout: null,
		bgm: '',
		bgmLocal: '',
		cover: '',
		pages: [],
		pagesLocal: [],
		isVideoPlaying: false,
		videoStyle: 'left:1000px;',
		videoHeight: 300,
		videoSrc: ''
	},
	methods: {
		getMagazineData() {
			if (!this.data.book && !(this.data.book === 0)) {
				this.showNetError();
				return;
			}
			const that = this;
			wx.request({
				url: 'https://xgbapi.zcoming.com/api/magazine/show',
				method: 'POST',
				data: {
					'magazine_id': this.data.book
				},
				success(res) {
					const data = res.data.data;
					that.setData({
						magazine: data
					});
					that.handleMagazineData();
				},
				fail(err) {
					if (that.data.retry > 0) {
						that.setData({
							retry: that.data.retry - 1
						});
						setTimeout(() => {
							that.getMagazineData();
						}, 0);
					} else {
						that.showNetError();
					}
				}
			});
		},
		showNetError() {
			wx.showModal({
				title: '网络错误',
				content: '未获取到杂志信息',
				showCancel: false,
				confirmText: '返回',
				confirmColor: '#000000',
				success() {
					wx.navigateBack({
						delta: 1
					});
				}
			});
		},
		handleMagazineData() {
			const {
				title,
				audio_url,
				tail_pic,
				page_join,
			} = this.data.magazine;
			wx.setNavigationBarTitle({
				title
			});
			this.setData({
				pages: page_join,
				bgm: audio_url,
				cover: tail_pic,
				isVideoPlaying: false,
				videoStyle: `left:${this.data.windowWidth}px;`,
			});
			this.initVideoContext();
			this.loadRes();
		},
		initVideoContext() {
			let hasVideo = false;
			this.data.pages.forEach(page => {
				if (page.type === 4 || page.type === 3) {
					hasVideo = true;
				}
			});
			this.setData({
				hasVideo,
			});
			if (hasVideo) {
				this.videoContext = wx.createVideoContext('common-video', this);
			}
		},
		loadRes() {
			const pages = this.data.pages;
			let resList = [this.data.cover];
			if (this.data.bgm) {
				resList.push(this.data.bgm);
			}
			pages.forEach(page => {
				[
					'pic',
					'video_cover',
					'base_pic',
					'sign_pic',
					'video_url',
				].forEach(key => {
					if (page[key]) {
						resList.push(page[key]);
					}
				});
				if (page.pic_join.length) {
					page.pic_join.forEach(item => {
						resList.push(item.pic);
					});
				}
			});
			this.setData({
				totalResCount: resList.length
			});
			res_loader_1.loadRes(resList.concat(), this.onProgress, this.onResLoaded, this);
		},
		onProgress(current) {
			let total = this.data.totalResCount;
			let progress = Number(100 * current / total).toFixed(0);
			this.setData({
				progress
			});
		},
		onResLoaded(loadedResList) {
			const getLocal = url => {
				for (let i = loadedResList.length - 1; i >= 0; i--) {
					if (loadedResList[i].origin === url) {
						return loadedResList[i].local;
					}
				}
			};
			if (this.data.bgm) {
				const bgmLocal = getLocal(this.data.bgm);
				this.setData({
					bgmLocal
				});
			}
			const pages = this.data.pages;
			let pagesLocal = JSON.parse(JSON.stringify(pages));
			pagesLocal.forEach(page => {
				[
					'pic',
					'video_cover',
					'base_pic',
					'sign_pic',
					'video_url',
				].forEach(key => {
					if (page[key]) {
						page[key] = getLocal(page[key]);
					}
				});
				if (page.pic_join.length) {
					page.pic_join.forEach(item => {
						item.pic = getLocal(item.pic);
					});
				}
			});
			this.setData({
				pagesLocal,
				loaded: true
			});
			setTimeout(() => {
				this.selectComponent(`.layout-${this.data.current}`).setEnter();
			}, 0);
		},
		onFinish({
			detail
		}) {
			let {
				current
			} = detail;
			let previous = this.data.current;
			if (previous !== current) {
				if (this.data.timeout) {
					clearTimeout(this.data.timeout);
					this.data.timeout = null;
				}
				this.data.timeout = setTimeout(() => {
					this.selectComponent(`.layout-${previous}`).setExit();
					this.selectComponent(`.layout-${current}`).setEnter();
				}, 0);
			}
			this.setData({
				current
			});
		},
		onSwipe({
			detail
		}) {
			this.setItemAnim(~~detail.dx);
			if (this.data.hasVideo) {
				this.stopPlay();
			}
		},
		setItemAnim(dx) {
			let sign = Math.sign(dx);
			let current = this.data.current;
			let next = sign + current;
			let step = Number(dx / this.data.windowWidth).toFixed(2);
			let abs = Math.abs(step);
			if (abs > 1) {
				let dis = sign * ~~abs;
				next += dis;
				current += dis;
				step -= dis;
			}
			if (0 <= next && next < this.data.pages.length) {
				this.selectComponent(`.layout-${next}`).setFrame(step, true);
			}
			this.selectComponent(`.layout-${current}`).setFrame(step, false);
		},
		onVideoPlay({
			detail
		}) {
			const videoContext = this.videoContext;
			if (!videoContext) {
				this.setData({
					isVideoPlaying: false
				});
				return;
			}
			let config = null;
			this.data.pagesLocal.forEach(page => {
				if (page.id === +detail) {
					config = page;
				}
			});
			const {
				type,
				video_url,
				video_cover
			} = config;
			const videoHeight = this.data.videoHeight;
			const videoStyle = type === 3 ?
				'height:100vh;top:0px;margin-top:0px;' :
				`height:${videoHeight}px;margin-top:-${~~(videoHeight / 2)}px;`;
			this.setData({
				isVideoPlaying: true,
				videoSrc: video_url,
				videoCover: video_cover,
			});
			wx.nextTick(() => {
				this.setData({
					videoStyle,
				});
				wx.nextTick(() => {
					videoContext.seek(0);
					videoContext.play();
				});
			});
		},
		stopPlay() {
			let windowWidth = this.data.windowWidth;
			this.setData({
				isVideoPlaying: false,
				videoStyle: `left:${windowWidth}px;`,
			});
			if (this.videoContext) {
				this.videoContext.pause();
			}
		},
	},
	lifetimes: {
		attached() {
			let that = this;
			wx.getSystemInfo({
				success({
					windowWidth,
					windowHeight
				}) {
					const videoHeight = ~~(windowWidth * 9 / 16);
					that.setData({
						windowWidth,
						windowHeight,
						videoHeight
					});
				}
			});
			wx.setNavigationBarTitle({
				title: '加载中'
			});
			this.getMagazineData();
		}
	}
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQUE0QztBQUU1QyxTQUFTLENBQUM7SUFHUixVQUFVLEVBQUU7UUFDVixJQUFJLEVBQUU7WUFDSixJQUFJLEVBQUUsTUFBTTtZQUNaLEtBQUssRUFBRSxFQUFFO1NBQ1Y7S0FDRjtJQUdELElBQUksRUFBRTtRQUVKLEtBQUssRUFBRSxDQUFDO1FBRVIsYUFBYSxFQUFFLENBQUM7UUFFaEIsUUFBUSxFQUFFLEdBQUc7UUFFYixNQUFNLEVBQUUsS0FBSztRQUViLFFBQVEsRUFBRSxLQUFLO1FBRWYsT0FBTyxFQUFFLENBQUM7UUFFVixZQUFZLEVBQUUsQ0FBQztRQUVmLE9BQU8sRUFBRSxJQUFJO1FBRWIsR0FBRyxFQUFFLEVBQUU7UUFDUCxRQUFRLEVBQUUsRUFBRTtRQUVaLEtBQUssRUFBRSxFQUFFO1FBRVQsS0FBSyxFQUFFLEVBQUU7UUFDVCxVQUFVLEVBQUUsRUFBRTtRQUVkLGNBQWMsRUFBRSxLQUFLO1FBRXJCLFVBQVUsRUFBRSxjQUFjO1FBQzFCLFdBQVcsRUFBRSxHQUFHO1FBQ2hCLFFBQVEsRUFBRSxFQUFFO0tBQ2I7SUFHRCxPQUFPLEVBQUU7UUFFUCxlQUFlO1lBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDOUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO2dCQUNuQixPQUFNO2FBQ1A7WUFDRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUE7WUFDakIsRUFBRSxDQUFDLE9BQU8sQ0FBQztnQkFDVCxHQUFHLEVBQUUsOENBQThDO2dCQUNuRCxNQUFNLEVBQUUsTUFBTTtnQkFDZCxJQUFJLEVBQUU7b0JBQ0osYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTtp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QUFRLENBQUMsR0FBRyxFQUFFO29CQUNmLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ3BCLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtnQkFDckIsQ0FBQyxDQUFDLENBQUE7WUFDSixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFDRCxRQUFRO1lBQ04sSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUE7WUFDdkMsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFFWCxjQUFjLEVBQUUsS0FBSztnQkFFckIsVUFBVSxFQUFFLFFBQVEsV0FBVyxLQUFLO2FBQ3JDLENBQUMsQ0FBQTtZQUNGLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDckIsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQTthQUMxQjtRQUNILENBQUM7S0FDRjtJQUdELFNBQVMsRUFBRTtRQUVULFFBQVE7WUFDTixJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7WUFFZixFQUFFLENBQUMsYUFBYSxDQUFDO2dCQUNmLE9BQU8sQ0FBQyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUU7b0JBQ25DLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUE7b0JBQzVDLElBQUksQ0FBQyxPQUFPLENBQUM7d0JBQ1gsV0FBVzt3QkFDWCxZQUFZO3dCQUNaLFdBQVc7cUJBQ1osQ0FBQyxDQUFBO2dCQUNKLENBQUM7YUFDRixDQUFDLENBQUE7WUFDRixFQUFFLENBQUMscUJBQXFCLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRSxLQUFLO2FBQ2IsQ0FBQyxDQUFBO1lBRUYsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFBO1FBQ3hCLENBQUM7S0FDRjtDQUVGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvYWRSZXMgfSBmcm9tICcuL3V0aWxzL3Jlcy1sb2FkZXInXG5cbkNvbXBvbmVudCh7XG5cbiAgLyoqIOe7hOS7tueahOWxnuaAp+WIl+ihqCAqL1xuICBwcm9wZXJ0aWVzOiB7XG4gICAgYm9vazoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgdmFsdWU6IDExXG4gICAgfVxuICB9LFxuXG4gIC8qKiDnu4Tku7bnmoTliJ3lp4vmlbDmja4gKi9cbiAgZGF0YToge1xuICAgIC8qKiByZXRyeSAqL1xuICAgIHJldHJ5OiAzLFxuICAgIC8qKiDotYTmupDmgLvmlbAgKi9cbiAgICB0b3RhbFJlc0NvdW50OiAxLFxuICAgIC8qKiDotYTmupDliqDovb3ov5vluqYgKi9cbiAgICBwcm9ncmVzczogJzAnLFxuICAgIC8qKiDotYTmupDmmK/lkKbliqDovb3lrozmr5UgKi9cbiAgICBsb2FkZWQ6IGZhbHNlLFxuICAgIC8qKiDmmK/lkKblrZjlnKh2aWRlbyAqL1xuICAgIGhhc1ZpZGVvOiBmYWxzZSxcbiAgICAvKiog5b2T5YmNbGF5b3V05LiL5qCHICovXG4gICAgY3VycmVudDogMCxcbiAgICAvKiog5ruR5Yqo5Ye95pWw6IqC5rWB5qCH6K6wICovXG4gICAgdGhyb3R0bGVGbGFnOiAwLFxuICAgIC8qKiDpobXpnaLliIfmjaJ0aW1lb3V05qCH6K6wICovXG4gICAgdGltZW91dDogbnVsbCxcbiAgICAvKiogYmdt5Zyw5Z2AICovXG4gICAgYmdtOiAnJyxcbiAgICBiZ21Mb2NhbDogJycsXG4gICAgLyoqIOWwgemdouWcsOWdgCAqL1xuICAgIGNvdmVyOiAnJyxcbiAgICAvKiogbGF5b3V05L+h5oGv5pWw57uEICovXG4gICAgcGFnZXM6IFtdLFxuICAgIHBhZ2VzTG9jYWw6IFtdLFxuICAgIC8qKiDmmK/lkKblnKjmkq3mlL7op4bpopEgKi9cbiAgICBpc1ZpZGVvUGxheWluZzogZmFsc2UsXG4gICAgLyoqIOinhumikeagt+W8jyAqL1xuICAgIHZpZGVvU3R5bGU6ICdsZWZ0OjEwMDBweDsnLFxuICAgIHZpZGVvSGVpZ2h0OiAzMDAsXG4gICAgdmlkZW9TcmM6ICcnXG4gIH0sXG5cbiAgLyoqIOe7hOS7tueahOaWueazleWIl+ihqCAqL1xuICBtZXRob2RzOiB7XG4gICAgLyoqIOiOt+WPluadguW/l+S/oeaBryAqL1xuICAgIGdldE1hZ2F6aW5lRGF0YSgpIHtcbiAgICAgIGlmICghdGhpcy5kYXRhLmJvb2sgJiYgISh0aGlzLmRhdGEuYm9vayA9PT0gMCkpIHtcbiAgICAgICAgdGhpcy5zaG93TmV0RXJyb3IoKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICB3eC5yZXF1ZXN0KHtcbiAgICAgICAgdXJsOiAnaHR0cHM6Ly94Z2JhcGkuemNvbWluZy5jb20vYXBpL21hZ2F6aW5lL3Nob3cnLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgICdtYWdhemluZV9pZCc6IHRoaXMuZGF0YS5ib29rXG4gICAgICAgIH0sXG4gICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5kYXRhLmRhdGFcbiAgICAgICAgICB0aGF0LnNldERhdGEoeyBtYWdhemluZTogZGF0YSB9KVxuICAgICAgICAgIHRoYXQuaGFuZGxlTWFnYXppbmVEYXRhKClcbiAgICAgICAgfSxcbiAgICAgICAgZmFpbChlcnIpIHtcbiAgICAgICAgICBpZiAodGhhdC5kYXRhLnJldHJ5ID4gMCkge1xuICAgICAgICAgICAgdGhhdC5zZXREYXRhKHsgcmV0cnk6IHRoYXQuZGF0YS5yZXRyeSAtIDEgfSlcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICB0aGF0LmdldE1hZ2F6aW5lRGF0YSgpXG4gICAgICAgICAgICB9LCAwKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGF0LnNob3dOZXRFcnJvcigpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0sXG4gICAgLyoqIOe9kee7nOaVhemanCAqL1xuICAgIHNob3dOZXRFcnJvcigpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn572R57uc6ZSZ6K+vJyxcbiAgICAgICAgY29udGVudDogJ+acquiOt+WPluWIsOadguW/l+S/oeaBrycsXG4gICAgICAgIHNob3dDYW5jZWw6IGZhbHNlLFxuICAgICAgICBjb25maXJtVGV4dDogJ+i/lOWbnicsXG4gICAgICAgIGNvbmZpcm1Db2xvcjogJyMwMDAwMDAnLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHd4Lm5hdmlnYXRlQmFjayh7XG4gICAgICAgICAgICBkZWx0YTogMVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSxcbiAgICAvKiog5aSE55CG5p2C5b+X5pWw5o2u5Lul5L6/5riy5p+TICovXG4gICAgaGFuZGxlTWFnYXppbmVEYXRhKCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICAvLyBpZCxcbiAgICAgICAgdGl0bGUsXG4gICAgICAgIGF1ZGlvX3VybCxcbiAgICAgICAgdGFpbF9waWMsXG4gICAgICAgIHBhZ2Vfam9pbixcbiAgICAgIH0gPSB0aGlzLmRhdGEubWFnYXppbmVcbiAgICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7XG4gICAgICAgIHRpdGxlXG4gICAgICB9KVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcGFnZXM6IHBhZ2Vfam9pbixcbiAgICAgICAgYmdtOiBhdWRpb191cmwsXG4gICAgICAgIGNvdmVyOiB0YWlsX3BpYyxcbiAgICAgICAgaXNWaWRlb1BsYXlpbmc6IGZhbHNlLFxuICAgICAgICB2aWRlb1N0eWxlOiBgbGVmdDoke3RoaXMuZGF0YS53aW5kb3dXaWR0aH1weDtgLFxuICAgICAgfSlcbiAgICAgIHRoaXMuaW5pdFZpZGVvQ29udGV4dCgpXG4gICAgICB0aGlzLmxvYWRSZXMoKVxuICAgIH0sXG4gICAgLyoqIOWIneWni+WMluinhumikeS4iuS4i+aWhyAqL1xuICAgIGluaXRWaWRlb0NvbnRleHQoKSB7XG4gICAgICBsZXQgaGFzVmlkZW8gPSBmYWxzZVxuICAgICAgdGhpcy5kYXRhLnBhZ2VzLmZvckVhY2gocGFnZSA9PiB7XG4gICAgICAgIGlmIChwYWdlLnR5cGUgPT09IDQgfHwgcGFnZS50eXBlID09PSAzKSB7XG4gICAgICAgICAgaGFzVmlkZW8gPSB0cnVlXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBoYXNWaWRlbyxcbiAgICAgIH0pXG4gICAgICBpZiAoaGFzVmlkZW8pIHtcbiAgICAgICAgdGhpcy52aWRlb0NvbnRleHQgPSB3eC5jcmVhdGVWaWRlb0NvbnRleHQoJ2NvbW1vbi12aWRlbycsIHRoaXMpXG4gICAgICB9XG4gICAgfSxcbiAgICAvKiog6aKE5Yqg6L295Zu+54mH6LWE5rqQICovXG4gICAgbG9hZFJlcygpIHtcbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5kYXRhLnBhZ2VzIGFzIEFycmF5PGFueT5cbiAgICAgIGxldCByZXNMaXN0ID0gW3RoaXMuZGF0YS5jb3Zlcl1cbiAgICAgIGlmICh0aGlzLmRhdGEuYmdtKSB7XG4gICAgICAgIHJlc0xpc3QucHVzaCh0aGlzLmRhdGEuYmdtKVxuICAgICAgfVxuICAgICAgcGFnZXMuZm9yRWFjaChwYWdlID0+IHtcbiAgICAgICAgW1xuICAgICAgICAgICdwaWMnLFxuICAgICAgICAgICd2aWRlb19jb3ZlcicsXG4gICAgICAgICAgJ2Jhc2VfcGljJyxcbiAgICAgICAgICAnc2lnbl9waWMnLFxuICAgICAgICAgICd2aWRlb191cmwnLFxuICAgICAgICBdLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICBpZiAocGFnZVtrZXldKSB7XG4gICAgICAgICAgICByZXNMaXN0LnB1c2gocGFnZVtrZXldKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgaWYgKHBhZ2UucGljX2pvaW4ubGVuZ3RoKSB7XG4gICAgICAgICAgcGFnZS5waWNfam9pbi5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgcmVzTGlzdC5wdXNoKGl0ZW0ucGljKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICB0b3RhbFJlc0NvdW50OiByZXNMaXN0Lmxlbmd0aFxuICAgICAgfSlcbiAgICAgIGxvYWRSZXMocmVzTGlzdC5jb25jYXQoKSwgdGhpcy5vblByb2dyZXNzLCB0aGlzLm9uUmVzTG9hZGVkLCB0aGlzKVxuICAgIH0sXG4gICAgb25Qcm9ncmVzcyhjdXJyZW50KSB7XG4gICAgICBsZXQgdG90YWwgPSB0aGlzLmRhdGEudG90YWxSZXNDb3VudFxuICAgICAgbGV0IHByb2dyZXNzID0gTnVtYmVyKDEwMCAqIGN1cnJlbnQgLyB0b3RhbCkudG9GaXhlZCgwKVxuICAgICAgdGhpcy5zZXREYXRhKHsgcHJvZ3Jlc3MgfSlcbiAgICB9LFxuICAgIC8qKiDlm77niYfpooTliqDovb3lrozmr5UgKi9cbiAgICBvblJlc0xvYWRlZChsb2FkZWRSZXNMaXN0OiBBcnJheTx7IG9yaWdpbiwgbG9jYWwgfT4pIHtcbiAgICAgIGNvbnN0IGdldExvY2FsID0gdXJsID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IGxvYWRlZFJlc0xpc3QubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICBpZiAobG9hZGVkUmVzTGlzdFtpXS5vcmlnaW4gPT09IHVybCkge1xuICAgICAgICAgICAgcmV0dXJuIGxvYWRlZFJlc0xpc3RbaV0ubG9jYWxcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmRhdGEuYmdtKSB7XG4gICAgICAgIGNvbnN0IGJnbUxvY2FsID0gZ2V0TG9jYWwodGhpcy5kYXRhLmJnbSlcbiAgICAgICAgdGhpcy5zZXREYXRhKHsgYmdtTG9jYWwgfSlcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5kYXRhLnBhZ2VzXG4gICAgICBsZXQgcGFnZXNMb2NhbCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocGFnZXMpKVxuICAgICAgcGFnZXNMb2NhbC5mb3JFYWNoKHBhZ2UgPT4ge1xuICAgICAgICBbXG4gICAgICAgICAgJ3BpYycsXG4gICAgICAgICAgJ3ZpZGVvX2NvdmVyJyxcbiAgICAgICAgICAnYmFzZV9waWMnLFxuICAgICAgICAgICdzaWduX3BpYycsXG4gICAgICAgICAgJ3ZpZGVvX3VybCcsXG4gICAgICAgIF0uZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgIGlmIChwYWdlW2tleV0pIHtcbiAgICAgICAgICAgIHBhZ2Vba2V5XSA9IGdldExvY2FsKHBhZ2Vba2V5XSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIGlmIChwYWdlLnBpY19qb2luLmxlbmd0aCkge1xuICAgICAgICAgIHBhZ2UucGljX2pvaW4uZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICAgIGl0ZW0ucGljID0gZ2V0TG9jYWwoaXRlbS5waWMpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7IHBhZ2VzTG9jYWwsIGxvYWRlZDogdHJ1ZSB9KVxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KGAubGF5b3V0LSR7dGhpcy5kYXRhLmN1cnJlbnR9YCkuc2V0RW50ZXIoKVxuICAgICAgfSwgMClcbiAgICB9LFxuICAgIC8qKiBzd2lwZXLliIfmjaLkuovku7YgKi9cbiAgICBvbkZpbmlzaCh7IGRldGFpbCB9KSB7XG4gICAgICBsZXQgeyBjdXJyZW50IH0gPSBkZXRhaWxcbiAgICAgIGxldCBwcmV2aW91cyA9IHRoaXMuZGF0YS5jdXJyZW50XG4gICAgICBpZiAocHJldmlvdXMgIT09IGN1cnJlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMuZGF0YS50aW1lb3V0KSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZGF0YS50aW1lb3V0KVxuICAgICAgICAgIHRoaXMuZGF0YS50aW1lb3V0ID0gbnVsbFxuICAgICAgICB9XG4gICAgICAgIC8vIHRpbWVvdXTlsZ7mgKfkuI3lj4LkuI7muLLmn5PvvIzlm6DmraTph4fnlKjnm7TmjqXotYvlgLznmoTmlrnlvI9cbiAgICAgICAgdGhpcy5kYXRhLnRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAvLyBzZXRFeGl0XG4gICAgICAgICAgdGhpcy5zZWxlY3RDb21wb25lbnQoYC5sYXlvdXQtJHtwcmV2aW91c31gKS5zZXRFeGl0KClcbiAgICAgICAgICAvLyBzZXRFbnRlclxuICAgICAgICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KGAubGF5b3V0LSR7Y3VycmVudH1gKS5zZXRFbnRlcigpXG4gICAgICAgIH0sIDApXG4gICAgICB9XG4gICAgICB0aGlzLnNldERhdGEoeyBjdXJyZW50IH0pXG4gICAgfSxcbiAgICAvKiogXG4gICAgICogc3dpcGVy5ruR5Yqo5LqL5Lu2XG4gICAgICogQGRhdGUgMjAxOS0xMC0yNFxuICAgICAqIEBhdXRob3IgY2hlbmd4dTE5NzNcbiAgICAgKiBAZGVzYyDph4fnlKjlkITnp43oioLmtYHmlrnms5XnmoTnnJ/mnLrmu5HliqjmlYjmnpzpg73kuI3lpb3vvIzlm6DmraTmmoLml7bkuI3oioLmtYFcbiAgICAgKi9cbiAgICBvblN3aXBlKHsgZGV0YWlsIH0pIHtcbiAgICAgIHRoaXMuc2V0SXRlbUFuaW0ofn5kZXRhaWwuZHgpXG4gICAgICBpZiAodGhpcy5kYXRhLmhhc1ZpZGVvKSB7XG4gICAgICAgIHRoaXMuc3RvcFBsYXkoKVxuICAgICAgfVxuICAgIH0sXG4gICAgLyoqIHN3aXBlcua7keWKqOS6i+S7tuiKgua1geWQjuWTjeW6lCAqL1xuICAgIHNldEl0ZW1BbmltKGR4KSB7XG4gICAgICBsZXQgc2lnbiA9IE1hdGguc2lnbihkeClcbiAgICAgIGxldCBjdXJyZW50ID0gdGhpcy5kYXRhLmN1cnJlbnRcbiAgICAgIGxldCBuZXh0ID0gc2lnbiArIGN1cnJlbnRcbiAgICAgIGxldCBzdGVwID0gTnVtYmVyKGR4IC8gdGhpcy5kYXRhLndpbmRvd1dpZHRoKS50b0ZpeGVkKDIpXG4gICAgICBsZXQgYWJzID0gTWF0aC5hYnMoc3RlcClcbiAgICAgIC8vIOW9k+WJjemhtemdoua7keWKqOacquWujOaIkOeahOaXtuWAmee7p+e7rea7keWKqOWPr+iDveWHuueOsHN0ZXDnu53lr7nlgLzlpKfkuo7kuIDnmoTmg4XlhrVcbiAgICAgIC8vIOatpOaXtmJpbmRhbmltYXRpb25maW5pc2jkuovku7blsJrmnKrop6blj5HvvIxjdXJyZW505pyq5pS55Y+YXG4gICAgICAvLyDpnIDopoHorqHnrpflvZPliY3mmL7npLrpobXpnaLnmoRpbmRleOi/m+ihjOa4suafk1xuICAgICAgaWYgKGFicyA+IDEpIHtcbiAgICAgICAgbGV0IGRpcyA9IHNpZ24gKiB+fmFic1xuICAgICAgICBuZXh0ICs9IGRpc1xuICAgICAgICBjdXJyZW50ICs9IGRpc1xuICAgICAgICBzdGVwIC09IGRpc1xuICAgICAgfVxuICAgICAgaWYgKDAgPD0gbmV4dCAmJiBuZXh0IDwgdGhpcy5kYXRhLnBhZ2VzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnNlbGVjdENvbXBvbmVudChgLmxheW91dC0ke25leHR9YCkuc2V0RnJhbWUoc3RlcCwgdHJ1ZSlcbiAgICAgIH1cbiAgICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KGAubGF5b3V0LSR7Y3VycmVudH1gKS5zZXRGcmFtZShzdGVwLCBmYWxzZSlcbiAgICB9LFxuICAgIC8qKiDlrZDnu4Tku7bop4bpopHmkq3mlL4gKi9cbiAgICBvblZpZGVvUGxheSh7IGRldGFpbCB9KSB7XG4gICAgICBjb25zdCB2aWRlb0NvbnRleHQgPSB0aGlzLnZpZGVvQ29udGV4dFxuICAgICAgaWYgKCF2aWRlb0NvbnRleHQpIHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBpc1ZpZGVvUGxheWluZzogZmFsc2VcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICAvLyDojrflj5bop4bpopHkv6Hmga9cbiAgICAgIGxldCBjb25maWc6IGFueSA9IG51bGxcbiAgICAgIHRoaXMuZGF0YS5wYWdlc0xvY2FsLmZvckVhY2gocGFnZSA9PiB7XG4gICAgICAgIGlmIChwYWdlLmlkID09PSArZGV0YWlsKSB7XG4gICAgICAgICAgY29uZmlnID0gcGFnZVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgY29uc3QgeyB0eXBlLCB2aWRlb191cmwsIHZpZGVvX2NvdmVyIH0gPSBjb25maWdcbiAgICAgIGNvbnN0IHZpZGVvSGVpZ2h0ID0gdGhpcy5kYXRhLnZpZGVvSGVpZ2h0XG4gICAgICBjb25zdCB2aWRlb1N0eWxlID0gdHlwZSA9PT0gMyA/XG4gICAgICAgICdoZWlnaHQ6MTAwdmg7dG9wOjBweDttYXJnaW4tdG9wOjBweDsnIDpcbiAgICAgICAgYGhlaWdodDoke3ZpZGVvSGVpZ2h0fXB4O21hcmdpbi10b3A6LSR7fn4odmlkZW9IZWlnaHQgLyAyKX1weDtgXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBpc1ZpZGVvUGxheWluZzogdHJ1ZSxcbiAgICAgICAgdmlkZW9TcmM6IHZpZGVvX3VybCxcbiAgICAgICAgdmlkZW9Db3ZlcjogdmlkZW9fY292ZXIsXG4gICAgICB9KVxuICAgICAgd3gubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIHZpZGVvU3R5bGUsXG4gICAgICAgIH0pXG4gICAgICAgIHd4Lm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICB2aWRlb0NvbnRleHQuc2VlaygwKVxuICAgICAgICAgIHZpZGVvQ29udGV4dC5wbGF5KClcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSxcbiAgICBzdG9wUGxheSgpIHtcbiAgICAgIGxldCB3aW5kb3dXaWR0aCA9IHRoaXMuZGF0YS53aW5kb3dXaWR0aFxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgLyoqIOaYr+WQpuWcqOaSreaUvuinhumikSAqL1xuICAgICAgICBpc1ZpZGVvUGxheWluZzogZmFsc2UsXG4gICAgICAgIC8qKiDop4bpopHmoLflvI8gKi9cbiAgICAgICAgdmlkZW9TdHlsZTogYGxlZnQ6JHt3aW5kb3dXaWR0aH1weDtgLFxuICAgICAgfSlcbiAgICAgIGlmICh0aGlzLnZpZGVvQ29udGV4dCkge1xuICAgICAgICB0aGlzLnZpZGVvQ29udGV4dC5wYXVzZSgpXG4gICAgICB9XG4gICAgfSxcbiAgfSxcblxuICAvKiog57uE5Lu255Sf5ZG95ZGo5pyf5Yu+5a2QICovXG4gIGxpZmV0aW1lczoge1xuICAgIC8vIOa3u+WKoOWIsOiInuWPsOWIneWni+WMluS6i+S7tlxuICAgIGF0dGFjaGVkKCkge1xuICAgICAgbGV0IHRoYXQgPSB0aGlzXG4gICAgICAvLyDojrflj5blsY/luZXlsLrlr7hcbiAgICAgIHd4LmdldFN5c3RlbUluZm8oe1xuICAgICAgICBzdWNjZXNzKHsgd2luZG93V2lkdGgsIHdpbmRvd0hlaWdodCB9KSB7XG4gICAgICAgICAgY29uc3QgdmlkZW9IZWlnaHQgPSB+fih3aW5kb3dXaWR0aCAqIDkgLyAxNilcbiAgICAgICAgICB0aGF0LnNldERhdGEoe1xuICAgICAgICAgICAgd2luZG93V2lkdGgsXG4gICAgICAgICAgICB3aW5kb3dIZWlnaHQsXG4gICAgICAgICAgICB2aWRlb0hlaWdodFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoe1xuICAgICAgICB0aXRsZTogJ+WKoOi9veS4rSdcbiAgICAgIH0pXG4gICAgICAvLyDojrflj5bmnYLlv5fkv6Hmga9cbiAgICAgIHRoaXMuZ2V0TWFnYXppbmVEYXRhKClcbiAgICB9XG4gIH1cblxufSlcbiJdfQ==
